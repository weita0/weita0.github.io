<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>ArrayBuffer | Restart | 重开</title><meta name=keywords content><meta name=description content='引子
对ArrayBuffer的关注，始于一次面试。那次面试，聊到Web Worker，被问到使用Worker是否一定能提升性能。
回答自然是否，一是Worker和主线程之间有通信开销，二是因为Worker本身是一个线程，创建新线程本身也有成本，三是增加了开发的调试成本。
然后被问到，通信开销具体有哪些。
答曰，主线程和Worker之间通过postMessage和onmessage来传递消息，每次消息传递都会深拷贝一份数据（所谓结构化克隆 | Structured Clone）。如果传递的数据量很大时（几十MB甚至更大），克隆的成本很高。
然后被问到，有什么办法可以规避吗。
&mldr;我表示不知道。
然后面试官很nice地告诉我，可以用ArrayBuffer来存储需要传递的数据，这样数据就可以被转移而非拷贝。
不知道多少人和我一样，对ArrayBuffer几乎可以说一无所知，作为前端开发，平时很少有机会和二进制、内存打交道。于是下来特意查了下，就有了这篇文章。
What is ArrayBuffer
MDN上是这么说的

ArrayBuffer对象用来表示通用的原始二进制数据缓冲区。

它是一个字节数组，通常在其他语言中称为byte array。你不能直接操作ArrayBuffer中的内容；而要通过类型化数组对象或DataView对象来操作，它们会将缓冲区中的数据表示为特定的格式，并通过这些格式来读写缓冲区的内容。

ArrayBuffer 是一个可转移对象。

ArrayBuffer 对象可以在初始化时传入 maxByteLength选项使其大小可变，通过resize()为可变ArrayBuffer分配一个新的大小。

ArrayBuffer 实例可以在不同的执行上下文之间传输，通过在调用postMessage时传入ArrayBuffer对象作为可转移对象来完成。

当ArrayBuffer对象被传输时，它原来的副本会被detached，不再可用。可以通过detached属性检查ArrayBuffer是否已分离。
A Real Scene
让我们来搭一个舞台，看一下ArrayBuffer在实际场景中的用法。
 1// index.tsx
 2import imgSrc0 from &#39;./images/image-0.jgp&#39;;
 3/* 省略 1 - 8 */
 4import imgSrc9 from &#39;./images/image-9.jpg&#39;;
 5
 6// 准备十张4k分辨率的图片，每张图片体积都不小于2M
 7const imgList = [imgSrc0, ..., imgSrc9];
 8
 9function Page() {
10  useEffect(() => {
11    const init = (src, idx) => {
12      const img = new Image();
13      img.src = src;
14      img.onload = () => {
15        const canvas: HTMLCanvasElement = document.createElement("canvas");
16        // 找到插槽
17        const container = document.getElementById(`slot-${idx}`);
18        if (!container) return;
19        
20        // 记录下图片的原始宽高
21        const width = img.width;
22        const height = img.height;
23        
24        // canvas大小和原始图片大小保持一致
25        canvas.width = width;
26        canvas.height = height;
27        
28        // 插入插槽
29        container.appendChild(canvas);
30
31        // 绘制图像
32        const ctx = canvas.getContext("2d");
33        ctx?.drawImage(img, 0, 0, width, height);
34      }
35    }
36    
37    imgList.forEach((src, idx) => {
38      init(src, idx);
39    })
40  }, []);
41  return (
42    <div>
43      <div className="flex flex-col gap-10">
44        {/* 准备十个插槽，每张图片对应的canvas放进对应的插槽中 */}
45        {images.map((_, idx) => (
46          <div id={`slot-${idx}`} key={idx} className="flex flex-row gap-10" ></div>
47        ))}
48      </div>
49    </div>
50  )
51}
现在页面上有十个canvas，每个canvas上都是一张根据4k分辨率的图片绘制的图像。我们将对这些图像做一些复杂处理，处理过程得是cpu密集型的，只有这样才能体现webworker的优势。GPT告诉我，可以用高斯模糊 ———— 一种经典的图像处理滤镜，常用于降噪、虚化背景、图像处理前的预处理。本质是对图像做二维卷积操作。'><meta name=author content><link rel=canonical href=https://weita0.github.io/posts/arraybuffer/><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://weita0.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://weita0.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://weita0.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://weita0.github.io/apple-touch-icon.png><link rel=mask-icon href=https://weita0.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://weita0.github.io/posts/arraybuffer/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://weita0.github.io/posts/arraybuffer/"><meta property="og:site_name" content="Restart | 重开"><meta property="og:title" content="ArrayBuffer"><meta property="og:description" content='引子 对ArrayBuffer的关注，始于一次面试。那次面试，聊到Web Worker，被问到使用Worker是否一定能提升性能。
回答自然是否，一是Worker和主线程之间有通信开销，二是因为Worker本身是一个线程，创建新线程本身也有成本，三是增加了开发的调试成本。
然后被问到，通信开销具体有哪些。
答曰，主线程和Worker之间通过postMessage和onmessage来传递消息，每次消息传递都会深拷贝一份数据（所谓结构化克隆 | Structured Clone）。如果传递的数据量很大时（几十MB甚至更大），克隆的成本很高。
然后被问到，有什么办法可以规避吗。
…我表示不知道。
然后面试官很nice地告诉我，可以用ArrayBuffer来存储需要传递的数据，这样数据就可以被转移而非拷贝。
不知道多少人和我一样，对ArrayBuffer几乎可以说一无所知，作为前端开发，平时很少有机会和二进制、内存打交道。于是下来特意查了下，就有了这篇文章。
What is ArrayBuffer MDN上是这么说的
ArrayBuffer对象用来表示通用的原始二进制数据缓冲区。
它是一个字节数组，通常在其他语言中称为byte array。你不能直接操作ArrayBuffer中的内容；而要通过类型化数组对象或DataView对象来操作，它们会将缓冲区中的数据表示为特定的格式，并通过这些格式来读写缓冲区的内容。
ArrayBuffer 是一个可转移对象。
ArrayBuffer 对象可以在初始化时传入 maxByteLength选项使其大小可变，通过resize()为可变ArrayBuffer分配一个新的大小。
ArrayBuffer 实例可以在不同的执行上下文之间传输，通过在调用postMessage时传入ArrayBuffer对象作为可转移对象来完成。
当ArrayBuffer对象被传输时，它原来的副本会被detached，不再可用。可以通过detached属性检查ArrayBuffer是否已分离。
A Real Scene 让我们来搭一个舞台，看一下ArrayBuffer在实际场景中的用法。
1// index.tsx 2import imgSrc0 from &#39;./images/image-0.jgp&#39;; 3/* 省略 1 - 8 */ 4import imgSrc9 from &#39;./images/image-9.jpg&#39;; 5 6// 准备十张4k分辨率的图片，每张图片体积都不小于2M 7const imgList = [imgSrc0, ..., imgSrc9]; 8 9function Page() { 10 useEffect(() => { 11 const init = (src, idx) => { 12 const img = new Image(); 13 img.src = src; 14 img.onload = () => { 15 const canvas: HTMLCanvasElement = document.createElement("canvas"); 16 // 找到插槽 17 const container = document.getElementById(`slot-${idx}`); 18 if (!container) return; 19 20 // 记录下图片的原始宽高 21 const width = img.width; 22 const height = img.height; 23 24 // canvas大小和原始图片大小保持一致 25 canvas.width = width; 26 canvas.height = height; 27 28 // 插入插槽 29 container.appendChild(canvas); 30 31 // 绘制图像 32 const ctx = canvas.getContext("2d"); 33 ctx?.drawImage(img, 0, 0, width, height); 34 } 35 } 36 37 imgList.forEach((src, idx) => { 38 init(src, idx); 39 }) 40 }, []); 41 return ( 42 <div> 43 <div className="flex flex-col gap-10"> 44 {/* 准备十个插槽，每张图片对应的canvas放进对应的插槽中 */} 45 {images.map((_, idx) => ( 46 <div id={`slot-${idx}`} key={idx} className="flex flex-row gap-10" ></div> 47 ))} 48 </div> 49 </div> 50 ) 51} 现在页面上有十个canvas，每个canvas上都是一张根据4k分辨率的图片绘制的图像。我们将对这些图像做一些复杂处理，处理过程得是cpu密集型的，只有这样才能体现webworker的优势。GPT告诉我，可以用高斯模糊 ———— 一种经典的图像处理滤镜，常用于降噪、虚化背景、图像处理前的预处理。本质是对图像做二维卷积操作。'><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-05-29T18:05:21+08:00"><meta property="article:modified_time" content="2025-05-29T18:05:21+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="ArrayBuffer"><meta name=twitter:description content='引子
对ArrayBuffer的关注，始于一次面试。那次面试，聊到Web Worker，被问到使用Worker是否一定能提升性能。
回答自然是否，一是Worker和主线程之间有通信开销，二是因为Worker本身是一个线程，创建新线程本身也有成本，三是增加了开发的调试成本。
然后被问到，通信开销具体有哪些。
答曰，主线程和Worker之间通过postMessage和onmessage来传递消息，每次消息传递都会深拷贝一份数据（所谓结构化克隆 | Structured Clone）。如果传递的数据量很大时（几十MB甚至更大），克隆的成本很高。
然后被问到，有什么办法可以规避吗。
&mldr;我表示不知道。
然后面试官很nice地告诉我，可以用ArrayBuffer来存储需要传递的数据，这样数据就可以被转移而非拷贝。
不知道多少人和我一样，对ArrayBuffer几乎可以说一无所知，作为前端开发，平时很少有机会和二进制、内存打交道。于是下来特意查了下，就有了这篇文章。
What is ArrayBuffer
MDN上是这么说的

ArrayBuffer对象用来表示通用的原始二进制数据缓冲区。

它是一个字节数组，通常在其他语言中称为byte array。你不能直接操作ArrayBuffer中的内容；而要通过类型化数组对象或DataView对象来操作，它们会将缓冲区中的数据表示为特定的格式，并通过这些格式来读写缓冲区的内容。

ArrayBuffer 是一个可转移对象。

ArrayBuffer 对象可以在初始化时传入 maxByteLength选项使其大小可变，通过resize()为可变ArrayBuffer分配一个新的大小。

ArrayBuffer 实例可以在不同的执行上下文之间传输，通过在调用postMessage时传入ArrayBuffer对象作为可转移对象来完成。

当ArrayBuffer对象被传输时，它原来的副本会被detached，不再可用。可以通过detached属性检查ArrayBuffer是否已分离。
A Real Scene
让我们来搭一个舞台，看一下ArrayBuffer在实际场景中的用法。
 1// index.tsx
 2import imgSrc0 from &#39;./images/image-0.jgp&#39;;
 3/* 省略 1 - 8 */
 4import imgSrc9 from &#39;./images/image-9.jpg&#39;;
 5
 6// 准备十张4k分辨率的图片，每张图片体积都不小于2M
 7const imgList = [imgSrc0, ..., imgSrc9];
 8
 9function Page() {
10  useEffect(() => {
11    const init = (src, idx) => {
12      const img = new Image();
13      img.src = src;
14      img.onload = () => {
15        const canvas: HTMLCanvasElement = document.createElement("canvas");
16        // 找到插槽
17        const container = document.getElementById(`slot-${idx}`);
18        if (!container) return;
19        
20        // 记录下图片的原始宽高
21        const width = img.width;
22        const height = img.height;
23        
24        // canvas大小和原始图片大小保持一致
25        canvas.width = width;
26        canvas.height = height;
27        
28        // 插入插槽
29        container.appendChild(canvas);
30
31        // 绘制图像
32        const ctx = canvas.getContext("2d");
33        ctx?.drawImage(img, 0, 0, width, height);
34      }
35    }
36    
37    imgList.forEach((src, idx) => {
38      init(src, idx);
39    })
40  }, []);
41  return (
42    <div>
43      <div className="flex flex-col gap-10">
44        {/* 准备十个插槽，每张图片对应的canvas放进对应的插槽中 */}
45        {images.map((_, idx) => (
46          <div id={`slot-${idx}`} key={idx} className="flex flex-row gap-10" ></div>
47        ))}
48      </div>
49    </div>
50  )
51}
现在页面上有十个canvas，每个canvas上都是一张根据4k分辨率的图片绘制的图像。我们将对这些图像做一些复杂处理，处理过程得是cpu密集型的，只有这样才能体现webworker的优势。GPT告诉我，可以用高斯模糊 ———— 一种经典的图像处理滤镜，常用于降噪、虚化背景、图像处理前的预处理。本质是对图像做二维卷积操作。'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://weita0.github.io/posts/"},{"@type":"ListItem","position":2,"name":"ArrayBuffer","item":"https://weita0.github.io/posts/arraybuffer/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"ArrayBuffer","name":"ArrayBuffer","description":"引子 对ArrayBuffer的关注，始于一次面试。那次面试，聊到Web Worker，被问到使用Worker是否一定能提升性能。\n回答自然是否，一是Worker和主线程之间有通信开销，二是因为Worker本身是一个线程，创建新线程本身也有成本，三是增加了开发的调试成本。\n然后被问到，通信开销具体有哪些。\n答曰，主线程和Worker之间通过postMessage和onmessage来传递消息，每次消息传递都会深拷贝一份数据（所谓结构化克隆 | Structured Clone）。如果传递的数据量很大时（几十MB甚至更大），克隆的成本很高。\n然后被问到，有什么办法可以规避吗。\n\u0026hellip;我表示不知道。\n然后面试官很nice地告诉我，可以用ArrayBuffer来存储需要传递的数据，这样数据就可以被转移而非拷贝。\n不知道多少人和我一样，对ArrayBuffer几乎可以说一无所知，作为前端开发，平时很少有机会和二进制、内存打交道。于是下来特意查了下，就有了这篇文章。\nWhat is ArrayBuffer MDN上是这么说的\nArrayBuffer对象用来表示通用的原始二进制数据缓冲区。\n它是一个字节数组，通常在其他语言中称为byte array。你不能直接操作ArrayBuffer中的内容；而要通过类型化数组对象或DataView对象来操作，它们会将缓冲区中的数据表示为特定的格式，并通过这些格式来读写缓冲区的内容。\nArrayBuffer 是一个可转移对象。\nArrayBuffer 对象可以在初始化时传入 maxByteLength选项使其大小可变，通过resize()为可变ArrayBuffer分配一个新的大小。\nArrayBuffer 实例可以在不同的执行上下文之间传输，通过在调用postMessage时传入ArrayBuffer对象作为可转移对象来完成。\n当ArrayBuffer对象被传输时，它原来的副本会被detached，不再可用。可以通过detached属性检查ArrayBuffer是否已分离。\nA Real Scene 让我们来搭一个舞台，看一下ArrayBuffer在实际场景中的用法。\n1// index.tsx 2import imgSrc0 from \u0026#39;./images/image-0.jgp\u0026#39;; 3/* 省略 1 - 8 */ 4import imgSrc9 from \u0026#39;./images/image-9.jpg\u0026#39;; 5 6// 准备十张4k分辨率的图片，每张图片体积都不小于2M 7const imgList = [imgSrc0, ..., imgSrc9]; 8 9function Page() { 10 useEffect(() =\u0026gt; { 11 const init = (src, idx) =\u0026gt; { 12 const img = new Image(); 13 img.src = src; 14 img.onload = () =\u0026gt; { 15 const canvas: HTMLCanvasElement = document.createElement(\u0026#34;canvas\u0026#34;); 16 // 找到插槽 17 const container = document.getElementById(`slot-${idx}`); 18 if (!container) return; 19 20 // 记录下图片的原始宽高 21 const width = img.width; 22 const height = img.height; 23 24 // canvas大小和原始图片大小保持一致 25 canvas.width = width; 26 canvas.height = height; 27 28 // 插入插槽 29 container.appendChild(canvas); 30 31 // 绘制图像 32 const ctx = canvas.getContext(\u0026#34;2d\u0026#34;); 33 ctx?.drawImage(img, 0, 0, width, height); 34 } 35 } 36 37 imgList.forEach((src, idx) =\u0026gt; { 38 init(src, idx); 39 }) 40 }, []); 41 return ( 42 \u0026lt;div\u0026gt; 43 \u0026lt;div className=\u0026#34;flex flex-col gap-10\u0026#34;\u0026gt; 44 {/* 准备十个插槽，每张图片对应的canvas放进对应的插槽中 */} 45 {images.map((_, idx) =\u0026gt; ( 46 \u0026lt;div id={`slot-${idx}`} key={idx} className=\u0026#34;flex flex-row gap-10\u0026#34; \u0026gt;\u0026lt;/div\u0026gt; 47 ))} 48 \u0026lt;/div\u0026gt; 49 \u0026lt;/div\u0026gt; 50 ) 51} 现在页面上有十个canvas，每个canvas上都是一张根据4k分辨率的图片绘制的图像。我们将对这些图像做一些复杂处理，处理过程得是cpu密集型的，只有这样才能体现webworker的优势。GPT告诉我，可以用高斯模糊 ———— 一种经典的图像处理滤镜，常用于降噪、虚化背景、图像处理前的预处理。本质是对图像做二维卷积操作。\n","keywords":[],"articleBody":"引子 对ArrayBuffer的关注，始于一次面试。那次面试，聊到Web Worker，被问到使用Worker是否一定能提升性能。\n回答自然是否，一是Worker和主线程之间有通信开销，二是因为Worker本身是一个线程，创建新线程本身也有成本，三是增加了开发的调试成本。\n然后被问到，通信开销具体有哪些。\n答曰，主线程和Worker之间通过postMessage和onmessage来传递消息，每次消息传递都会深拷贝一份数据（所谓结构化克隆 | Structured Clone）。如果传递的数据量很大时（几十MB甚至更大），克隆的成本很高。\n然后被问到，有什么办法可以规避吗。\n…我表示不知道。\n然后面试官很nice地告诉我，可以用ArrayBuffer来存储需要传递的数据，这样数据就可以被转移而非拷贝。\n不知道多少人和我一样，对ArrayBuffer几乎可以说一无所知，作为前端开发，平时很少有机会和二进制、内存打交道。于是下来特意查了下，就有了这篇文章。\nWhat is ArrayBuffer MDN上是这么说的\nArrayBuffer对象用来表示通用的原始二进制数据缓冲区。\n它是一个字节数组，通常在其他语言中称为byte array。你不能直接操作ArrayBuffer中的内容；而要通过类型化数组对象或DataView对象来操作，它们会将缓冲区中的数据表示为特定的格式，并通过这些格式来读写缓冲区的内容。\nArrayBuffer 是一个可转移对象。\nArrayBuffer 对象可以在初始化时传入 maxByteLength选项使其大小可变，通过resize()为可变ArrayBuffer分配一个新的大小。\nArrayBuffer 实例可以在不同的执行上下文之间传输，通过在调用postMessage时传入ArrayBuffer对象作为可转移对象来完成。\n当ArrayBuffer对象被传输时，它原来的副本会被detached，不再可用。可以通过detached属性检查ArrayBuffer是否已分离。\nA Real Scene 让我们来搭一个舞台，看一下ArrayBuffer在实际场景中的用法。\n1// index.tsx 2import imgSrc0 from './images/image-0.jgp'; 3/* 省略 1 - 8 */ 4import imgSrc9 from './images/image-9.jpg'; 5 6// 准备十张4k分辨率的图片，每张图片体积都不小于2M 7const imgList = [imgSrc0, ..., imgSrc9]; 8 9function Page() { 10 useEffect(() =\u003e { 11 const init = (src, idx) =\u003e { 12 const img = new Image(); 13 img.src = src; 14 img.onload = () =\u003e { 15 const canvas: HTMLCanvasElement = document.createElement(\"canvas\"); 16 // 找到插槽 17 const container = document.getElementById(`slot-${idx}`); 18 if (!container) return; 19 20 // 记录下图片的原始宽高 21 const width = img.width; 22 const height = img.height; 23 24 // canvas大小和原始图片大小保持一致 25 canvas.width = width; 26 canvas.height = height; 27 28 // 插入插槽 29 container.appendChild(canvas); 30 31 // 绘制图像 32 const ctx = canvas.getContext(\"2d\"); 33 ctx?.drawImage(img, 0, 0, width, height); 34 } 35 } 36 37 imgList.forEach((src, idx) =\u003e { 38 init(src, idx); 39 }) 40 }, []); 41 return ( 42 \u003cdiv\u003e 43 \u003cdiv className=\"flex flex-col gap-10\"\u003e 44 {/* 准备十个插槽，每张图片对应的canvas放进对应的插槽中 */} 45 {images.map((_, idx) =\u003e ( 46 \u003cdiv id={`slot-${idx}`} key={idx} className=\"flex flex-row gap-10\" \u003e\u003c/div\u003e 47 ))} 48 \u003c/div\u003e 49 \u003c/div\u003e 50 ) 51} 现在页面上有十个canvas，每个canvas上都是一张根据4k分辨率的图片绘制的图像。我们将对这些图像做一些复杂处理，处理过程得是cpu密集型的，只有这样才能体现webworker的优势。GPT告诉我，可以用高斯模糊 ———— 一种经典的图像处理滤镜，常用于降噪、虚化背景、图像处理前的预处理。本质是对图像做二维卷积操作。\n高斯函数： G(x, y) = (1 / 2πσ²) * e^(-(x² + y²)/2σ²)\n我们得到一个对图片进行高斯模糊处理的函数，函数的具体实现这里无需关心，反正计算量很大。\n我们把函数封装在一个模块里，方法名就叫applyGaussianBlur。\n函数签名如下\n1// gaussian.ts 2interface BlurOptions { 3 kernelSize: number; // 核体积：3、5、7 4 sigma: number; // 标准差 5} 6 7function applyGaussianBlur( 8 input: Unit8ClampedArray, 9 output: Unit8ClampedArray, width: number, 10 height: number, 11 options: BlurOptions 12): void 现在，给页面增加一个按钮，点击按钮，调用我们的方法对十张图像进行模糊处理\n1function processImage (buffer: ArrayBuffer, width: number, height: number) { 2 const input = new Unit8ClampedArray(buffer); 3 const output = new Unit8ClampedArray(input.length); 4 applyGaussianBlur(input, output, width, height, { 5 kernelSize: 7, 6 sigma: 1.5, 7 }) 8 return output; 9} 10 11function Page() { 12 useEffect(() =\u003e { 13 const init = (src, idx) =\u003e { 14 const img = new Image(); 15 img.src = src; 16 img.onload = () =\u003e { 17 const canvas: HTMLCanvasElement = document.createElement(\"canvas\"); 18 // 找到插槽 19 const container = document.getElementById(`slot-${idx}`); 20 if (!container) return; 21 22 // 记录下图片的原始宽高 23 const width = img.width; 24 const height = img.height; 25 26 // canvas大小和原始图片大小保持一致 27 canvas.width = width; 28 canvas.height = height; 29 30 // 插入插槽 31 container.appendChild(canvas); 32 33 // 绘制图像 34 const ctx = canvas.getContext(\"2d\"); 35 ctx?.drawImage(img, 0, 0, width, height); 36 } 37 } 38 39 imgList.forEach((src, idx) =\u003e { 40 init(src, idx); 41 }) 42 }, []); 43 44 const startGaussianBlur = () =\u003e { 45 const now = performance.now(); 46 document.querySelectorAll(\"canvas\").forEach((canvas, idx) =\u003e { 47 const ctx = canvas.getContext(\"2d\"); 48 49 const width = canvas.width; 50 const height = canvas.height; 51 52 const imageData = ctx?.getImageData(0, 0, width, height); 53 const buffer = imageData?.data.buffer; 54 55 const processedData = processImage(buffer as ArrayBuffer, width, height); 56 ctx?.putImageData(new ImageData(processedData, width, height), 0, 0); 57 }) 58 console.log(`timing:, ${(performance.now() - now) / 1000}s`); 59 } 60 61 return ( 62 \u003cdiv\u003e 63 \u003cbutton onClick={startGaussianBlur}\u003e模糊处理\u003c/button\u003e 64 \u003cdiv className=\"flex flex-col gap-10\"\u003e 65 {/* 准备十个插槽，每张图片对应的canvas放进对应的插槽中 */} 66 {images.map((_, idx) =\u003e ( 67 \u003cdiv id={`slot-${idx}`} key={idx} className=\"flex flex-row gap-10\" \u003e\u003c/div\u003e 68 ))} 69 \u003c/div\u003e 70 \u003c/div\u003e 71 ) 72} 在startGaussianBlur方法里顺便记录一下操作的耗时。\n现在，点击按钮，可以看到我们对图片的处理生效了。\n处理前 处理后 处理完十张图片，控制台输出2.76s，和Performance里看到的INP指标2808ms相差不大，意味着页面有2.8s的卡顿，这通常是不可接受的。\n让我们把繁重的计算放进Worker中。Web Worker的会在后台启动一个执行给定脚本的线程，这个线程不会干扰主线程。此外，在Web Worker中还可以调用fetch和XMLHttpRequest方法来发起网络请求。Worker和创建它的JavaScript代码之间可以通过postMessage发送数据，通过监听onmessage事件来接收数据。\n让我们来创建一个worker。\nimport { applyGaussianBlur } from \"./gaussian\"; self.onmessage = (e: MessageEvent) =\u003e { const { taskId, payload: buffer, width, height, kernelSize = 7, sigma = 1.5, } = e.data; const input = new Uint8ClampedArray(buffer); const output = new Uint8ClampedArray(input.length); applyGaussianBlur(input, output, width, height, { kernelSize, sigma, }); // @ts-ignore self.postMessage({ taskId, result: output.buffer, width, height }, [ output.buffer, ]); }; 然后修改下上面的startGaussianBlur方法，在页面上创建并调用这个Worker。\n1const startGaussianBlur = () =\u003e { 2 const now = performance.now(); 3 document.querySelectorAll(\"canvas\").forEach((canvas, idx) =\u003e { 4 const ctx = canvas.getContext(\"2d\"); 5 6 const width = canvas.width; 7 const height = canvas.height; 8 9 const imageData = ctx?.getImageData(0, 0, width, height); 10 const buffer = imageData?.data.buffer; 11 12 const worker = new Worker(new URL(\"./worker\", import.meta.url), {type: \"module\"}); 13 worker.onmessage = (e: MessageEvent) =\u003e { 14 const { result } = e.data; 15 ctx?.putImageData(new ImageData(new Uint8ClampedArray(result), width, height), 0, 0); 16 } 17 worker.postMessage({ 18 taskId: idx, 19 payload: buffer, 20 width, 21 height, 22 kernelSize: 7, 23 sigma: 1.5, 24 }); 25 }) 26 console.log(`timing:, ${(performance.now() - now) / 1000}s`); 27} 注意下，这里对Worker实例化时的方式，使用webpack或vite打包的项目，路径是相对当前js文件的路径，而不是相对HTML页面的路径。如果直接new Worker('./worker') 实际执行时会404。并且由于worker中使用了import，需要在第二个参数中指定type: 'module'。\n再点击按钮看下效果，BOOM！时间一下缩短到了0.049s，INP也来到了88ms。 其实，还有优化空间。不知道你注意到没有，我们这里为每张图片都创建了一个单独的Worker，这样，总共就会创建十个Worker。这样显然是不可取的，本文开头提到，创建Worker是有性能开销的，不可能为一个任务单独创建一个Worker。\n针对这一点，我们可以增加一个额外的线程池，让Worker得以重复使用。\n线程池的代码就不贴在本文了，因为有些偏离主题，如果感兴趣可以点这里查看代码。\n增加线程池后，我们用3个Worker实例来处理十张图片，用时是0.036s，INP来到80ms，可以看到并不比启用十个Worker慢，并且性能开销肯定小得多。\n结语 回到主题，buffer在Woker和主线程之间通信，是被转移而不是被拷贝。那么如何验证呢。\n还记得文章开头引用的MDN吗，被转移后的buffer，detached属性会变为true，意味着内存已经和引用分离，因此length也会变为0。让我们来实际验证下。\n1import { applyGaussianBlur } from \"./gaussian\"; 2 3self.onmessage = (e: MessageEvent) =\u003e { 4 const { 5 taskId, 6 payload: buffer, 7 width, 8 height, 9 kernelSize = 7, 10 sigma = 1.5, 11 } = e.data; 12 const input = new Uint8ClampedArray(buffer); 13 const output = new Uint8ClampedArray(input.length); 14 15 console.group('before'); 16 console.log('detached ?', output.buffer.detached); 17 console.log(' length ?', output.buffer.byteLength); 18 console.groupEnd(); 19 20 applyGaussianBlur(input, output, width, height, { 21 kernelSize, 22 sigma, 23 }); 24 25 // @ts-ignore 26 self.postMessage({ taskId, result: output.buffer, width, height }, [ 27 output.buffer, 28 ]); 29 30 console.group('after'); 31 console.log('detached ?', output.buffer.detached); 32 console.log(' length ?', output.buffer.byteLength); 33 console.groupEnd(); 34}; 符合预期！\n至此，咱们是否可以说「No one knows ArrayBuffer better than me」了？（手动狗头）（End）\n","wordCount":"839","inLanguage":"en","datePublished":"2025-05-29T18:05:21+08:00","dateModified":"2025-05-29T18:05:21+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://weita0.github.io/posts/arraybuffer/"},"publisher":{"@type":"Organization","name":"Restart | 重开","logo":{"@type":"ImageObject","url":"https://weita0.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://weita0.github.io/ accesskey=h title="Restart | 重开 (Alt + H)">Restart | 重开</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">ArrayBuffer</h1><div class=post-meta><span title='2025-05-29 18:05:21 +0800 CST'>May 29, 2025</span></div></header><div class=post-content><h2 id=引子>引子<a hidden class=anchor aria-hidden=true href=#引子>#</a></h2><p>对<code>ArrayBuffer</code>的关注，始于一次面试。那次面试，聊到Web Worker，被问到使用<code>Worker</code>是否一定能提升性能。</p><p>回答自然是否，一是<code>Worker</code>和主线程之间有通信开销，二是因为<code>Worker</code>本身是一个线程，创建新线程本身也有成本，三是增加了开发的调试成本。</p><p>然后被问到，通信开销具体有哪些。</p><p>答曰，主线程和<code>Worker</code>之间通过<code>postMessage</code>和<code>onmessage</code>来传递消息，每次消息传递都会深拷贝一份数据（所谓结构化克隆 | Structured Clone）。如果传递的数据量很大时（几十MB甚至更大），克隆的成本很高。</p><p>然后被问到，有什么办法可以规避吗。</p><p>&mldr;我表示不知道。</p><p>然后面试官很nice地告诉我，可以用<code>ArrayBuffer</code>来存储需要传递的数据，这样数据就可以被<code>转移</code>而非<code>拷贝</code>。</p><p>不知道多少人和我一样，对<code>ArrayBuffer</code>几乎可以说一无所知，作为前端开发，平时很少有机会和二进制、内存打交道。于是下来特意查了下，就有了这篇文章。</p><h2 id=what-is-arraybuffer>What is ArrayBuffer<a hidden class=anchor aria-hidden=true href=#what-is-arraybuffer>#</a></h2><p>MDN上是这么说的</p><blockquote><p><code>ArrayBuffer</code>对象用来表示通用的原始二进制数据缓冲区。</p></blockquote><blockquote><p>它是一个字节数组，通常在其他语言中称为<code>byte array</code>。你不能直接操作<code>ArrayBuffer</code>中的内容；而要通过类型化数组对象或<code>DataView</code>对象来操作，它们会将缓冲区中的数据表示为特定的格式，并通过这些格式来读写缓冲区的内容。</p></blockquote><blockquote><p><strong><code>ArrayBuffer</code> 是一个可转移对象</strong>。</p></blockquote><blockquote><p>ArrayBuffer 对象可以在初始化时传入 <code>maxByteLength</code>选项使其大小可变，通过<code>resize()</code>为可变<code>ArrayBuffer</code>分配一个新的大小。</p></blockquote><blockquote><p>ArrayBuffer 实例可以在不同的执行上下文之间传输，通过在调用<code>postMessage</code>时传入<code>ArrayBuffer对象</code>作为<code>可转移对象</code>来完成。</p></blockquote><blockquote><p>当ArrayBuffer对象被传输时，它原来的副本会被<code>detached</code>，不再可用。可以通过<code>detached</code>属性检查<code>ArrayBuffer</code>是否已分离。</p></blockquote><h2 id=a-real-scene>A Real Scene<a hidden class=anchor aria-hidden=true href=#a-real-scene>#</a></h2><p>让我们来搭一个舞台，看一下ArrayBuffer在实际场景中的用法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tsx data-lang=tsx><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#75715e>// index.tsx
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>imgSrc0</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;./images/image-0.jgp&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#75715e>/* 省略 1 - 8 */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>imgSrc9</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;./images/image-9.jpg&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#75715e>// 准备十张4k分辨率的图片，每张图片体积都不小于2M
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>imgList</span> <span style=color:#f92672>=</span> [<span style=color:#a6e22e>imgSrc0</span>, ..., <span style=color:#a6e22e>imgSrc9</span>];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>Page() {</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  <span style=color:#a6e22e>useEffect</span>(() <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>init</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>src</span>, <span style=color:#a6e22e>idx</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>img</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Image</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>      <span style=color:#a6e22e>img</span>.<span style=color:#a6e22e>src</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>src</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>      <span style=color:#a6e22e>img</span>.<span style=color:#a6e22e>onload</span> <span style=color:#f92672>=</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>canvas</span>: <span style=color:#66d9ef>HTMLCanvasElement</span> <span style=color:#f92672>=</span> document.<span style=color:#a6e22e>createElement</span>(<span style=color:#e6db74>&#34;canvas&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        <span style=color:#75715e>// 找到插槽
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#75715e></span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>container</span> <span style=color:#f92672>=</span> document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>`slot-</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>idx</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>container</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        <span style=color:#75715e>// 记录下图片的原始宽高
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#75715e></span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>width</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>img</span>.<span style=color:#a6e22e>width</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>height</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>img</span>.<span style=color:#a6e22e>height</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>        
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>        <span style=color:#75715e>// canvas大小和原始图片大小保持一致
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#75715e></span>        <span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>width</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>width</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>        <span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>height</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>height</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>        
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>        <span style=color:#75715e>// 插入插槽
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#75715e></span>        <span style=color:#a6e22e>container</span>.<span style=color:#a6e22e>appendChild</span>(<span style=color:#a6e22e>canvas</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>        <span style=color:#75715e>// 绘制图像
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#75715e></span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ctx</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>getContext</span>(<span style=color:#e6db74>&#34;2d&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>        <span style=color:#a6e22e>ctx</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>drawImage</span>(<span style=color:#a6e22e>img</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>width</span>, <span style=color:#a6e22e>height</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>    <span style=color:#a6e22e>imgList</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>src</span>, <span style=color:#a6e22e>idx</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>      <span style=color:#a6e22e>init</span>(<span style=color:#a6e22e>src</span>, <span style=color:#a6e22e>idx</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>    })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>  }, []);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>  <span style=color:#66d9ef>return</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>    &lt;<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>      &lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>className</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;flex flex-col gap-10&#34;</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>        {<span style=color:#75715e>/* 准备十个插槽，每张图片对应的canvas放进对应的插槽中 */</span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>        {<span style=color:#a6e22e>images</span>.<span style=color:#a6e22e>map</span>((<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>idx</span>) <span style=color:#f92672>=&gt;</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>          &lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span>{<span style=color:#e6db74>`slot-</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>idx</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>} <span style=color:#a6e22e>key</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>idx</span>} <span style=color:#a6e22e>className</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;flex flex-row gap-10&#34;</span> &gt;&lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>        ))}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>      &lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>    &lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>  )
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>}
</span></span></code></pre></div><p>现在页面上有十个canvas，每个canvas上都是一张根据4k分辨率的图片绘制的图像。我们将对这些图像做一些复杂处理，处理过程得是cpu密集型的，只有这样才能体现webworker的优势。GPT告诉我，可以用<code>高斯模糊</code> ———— 一种经典的图像处理滤镜，常用于降噪、虚化背景、图像处理前的预处理。本质是对图像做二维卷积操作。</p><blockquote><p>高斯函数：
G(x, y) = (1 / 2πσ²) * e^(-(x² + y²)/2σ²)</p></blockquote><p>我们得到一个对图片进行<code>高斯模糊</code>处理的函数，函数的具体实现这里无需关心，反正计算量很大。</p><p>我们把函数封装在一个模块里，方法名就叫<code>applyGaussianBlur</code>。</p><p>函数签名如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#75715e>// gaussian.ts
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#75715e></span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>BlurOptions</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  <span style=color:#a6e22e>kernelSize</span>: <span style=color:#66d9ef>number</span>; <span style=color:#75715e>// 核体积：3、5、7
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#75715e></span>  <span style=color:#a6e22e>sigma</span>: <span style=color:#66d9ef>number</span>; <span style=color:#75715e>// 标准差
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>applyGaussianBlur</span>(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>  <span style=color:#a6e22e>input</span>: <span style=color:#66d9ef>Unit8ClampedArray</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  <span style=color:#a6e22e>output</span>: <span style=color:#66d9ef>Unit8ClampedArray</span>, <span style=color:#a6e22e>width</span>: <span style=color:#66d9ef>number</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  <span style=color:#a6e22e>height</span>: <span style=color:#66d9ef>number</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>  <span style=color:#a6e22e>options</span>: <span style=color:#66d9ef>BlurOptions</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span>
</span></span></code></pre></div><p>现在，给页面增加一个按钮，点击按钮，调用我们的方法对十张图像进行模糊处理</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-tsx data-lang=tsx><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>processImage</span> (<span style=color:#a6e22e>buffer</span>: <span style=color:#66d9ef>ArrayBuffer</span>, <span style=color:#a6e22e>width</span>: <span style=color:#66d9ef>number</span>, <span style=color:#a6e22e>height</span>: <span style=color:#66d9ef>number</span>) {
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>input</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Unit8ClampedArray</span>(<span style=color:#a6e22e>buffer</span>);      
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>output</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Unit8ClampedArray</span>(<span style=color:#a6e22e>input</span>.<span style=color:#a6e22e>length</span>);
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  <span style=color:#a6e22e>applyGaussianBlur</span>(<span style=color:#a6e22e>input</span>, <span style=color:#a6e22e>output</span>, <span style=color:#a6e22e>width</span>, <span style=color:#a6e22e>height</span>, {
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#a6e22e>kernelSize</span>: <span style=color:#66d9ef>7</span>,
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#a6e22e>sigma</span>: <span style=color:#66d9ef>1.5</span>,
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  })
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>output</span>;
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>Page() {</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>  <span style=color:#a6e22e>useEffect</span>(() <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>init</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>src</span>, <span style=color:#a6e22e>idx</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>img</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Image</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>      <span style=color:#a6e22e>img</span>.<span style=color:#a6e22e>src</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>src</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>      <span style=color:#a6e22e>img</span>.<span style=color:#a6e22e>onload</span> <span style=color:#f92672>=</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>canvas</span>: <span style=color:#66d9ef>HTMLCanvasElement</span> <span style=color:#f92672>=</span> document.<span style=color:#a6e22e>createElement</span>(<span style=color:#e6db74>&#34;canvas&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        <span style=color:#75715e>// 找到插槽
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#75715e></span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>container</span> <span style=color:#f92672>=</span> document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>`slot-</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>idx</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>container</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>        <span style=color:#75715e>// 记录下图片的原始宽高
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#75715e></span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>width</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>img</span>.<span style=color:#a6e22e>width</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>height</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>img</span>.<span style=color:#a6e22e>height</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>        
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>        <span style=color:#75715e>// canvas大小和原始图片大小保持一致
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#75715e></span>        <span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>width</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>width</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>        <span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>height</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>height</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>        
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>        <span style=color:#75715e>// 插入插槽
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#75715e></span>        <span style=color:#a6e22e>container</span>.<span style=color:#a6e22e>appendChild</span>(<span style=color:#a6e22e>canvas</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>        <span style=color:#75715e>// 绘制图像
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#75715e></span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ctx</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>getContext</span>(<span style=color:#e6db74>&#34;2d&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>        <span style=color:#a6e22e>ctx</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>drawImage</span>(<span style=color:#a6e22e>img</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>width</span>, <span style=color:#a6e22e>height</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>    <span style=color:#a6e22e>imgList</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>src</span>, <span style=color:#a6e22e>idx</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>      <span style=color:#a6e22e>init</span>(<span style=color:#a6e22e>src</span>, <span style=color:#a6e22e>idx</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>    })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>  }, []);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>  
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>startGaussianBlur</span> <span style=color:#f92672>=</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>now</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>performance</span>.<span style=color:#a6e22e>now</span>();
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>    document.<span style=color:#a6e22e>querySelectorAll</span>(<span style=color:#e6db74>&#34;canvas&#34;</span>).<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>canvas</span>, <span style=color:#a6e22e>idx</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ctx</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>getContext</span>(<span style=color:#e6db74>&#34;2d&#34;</span>);
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>width</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>width</span>;
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>height</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>height</span>;
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>imageData</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ctx</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>getImageData</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>width</span>, <span style=color:#a6e22e>height</span>);
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>buffer</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>imageData</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>buffer</span>;
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>processedData</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>processImage</span>(<span style=color:#a6e22e>buffer</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>ArrayBuffer</span>, <span style=color:#a6e22e>width</span>, <span style=color:#a6e22e>height</span>);
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>      <span style=color:#a6e22e>ctx</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>putImageData</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ImageData</span>(<span style=color:#a6e22e>processedData</span>, <span style=color:#a6e22e>width</span>, <span style=color:#a6e22e>height</span>), <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>    })
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`timing:, </span><span style=color:#e6db74>${</span>(<span style=color:#a6e22e>performance</span>.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>-</span> <span style=color:#a6e22e>now</span>) <span style=color:#f92672>/</span> <span style=color:#ae81ff>1000</span><span style=color:#e6db74>}</span><span style=color:#e6db74>s`</span>);
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>  <span style=color:#66d9ef>return</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>    &lt;<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span>      &lt;<span style=color:#f92672>button</span> <span style=color:#a6e22e>onClick</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>startGaussianBlur</span>}&gt;<span style=color:#960050;background-color:#1e0010>模糊处理</span>&lt;/<span style=color:#f92672>button</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span>      &lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>className</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;flex flex-col gap-10&#34;</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>        {<span style=color:#75715e>/* 准备十个插槽，每张图片对应的canvas放进对应的插槽中 */</span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>        {<span style=color:#a6e22e>images</span>.<span style=color:#a6e22e>map</span>((<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>idx</span>) <span style=color:#f92672>=&gt;</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span>          &lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span>{<span style=color:#e6db74>`slot-</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>idx</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>} <span style=color:#a6e22e>key</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>idx</span>} <span style=color:#a6e22e>className</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;flex flex-row gap-10&#34;</span> &gt;&lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68</span><span>        ))}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69</span><span>      &lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70</span><span>    &lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71</span><span>  )
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72</span><span>}
</span></span></code></pre></div><p>在<code>startGaussianBlur</code>方法里顺便记录一下操作的耗时。</p><p>现在，点击按钮，可以看到我们对图片的处理生效了。</p><p>处理前
<img loading=lazy src=/posts/arraybuffer/images/before.png></p><p>处理后
<img loading=lazy src=/posts/arraybuffer/images/after.png></p><p>处理完十张图片，控制台输出<code>2.76s</code>，和Performance里看到的<code>INP</code>指标<code>2808ms</code>相差不大，意味着页面有<code>2.8s</code>的卡顿，这通常是不可接受的。</p><p>让我们把繁重的计算放进<code>Worker</code>中。<code>Web Worker</code>的会在后台启动一个执行给定脚本的<code>线程</code>，这个线程不会干扰主线程。此外，在<code>Web Worker</code>中还可以调用<code>fetch</code>和<code>XMLHttpRequest</code>方法来发起网络请求。<code>Worker</code>和创建它的JavaScript代码之间可以通过<code>postMessage</code>发送数据，通过监听<code>onmessage</code>事件来接收数据。</p><p>让我们来创建一个<code>worker</code>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>applyGaussianBlur</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;./gaussian&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>self</span>.<span style=color:#a6e22e>onmessage</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>e</span>: <span style=color:#66d9ef>MessageEvent</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>taskId</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>payload</span>: <span style=color:#66d9ef>buffer</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>width</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>height</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kernelSize</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>7</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sigma</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1.5</span>,
</span></span><span style=display:flex><span>  } <span style=color:#f92672>=</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>data</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>input</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Uint8ClampedArray</span>(<span style=color:#a6e22e>buffer</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>output</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Uint8ClampedArray</span>(<span style=color:#a6e22e>input</span>.<span style=color:#a6e22e>length</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>applyGaussianBlur</span>(<span style=color:#a6e22e>input</span>, <span style=color:#a6e22e>output</span>, <span style=color:#a6e22e>width</span>, <span style=color:#a6e22e>height</span>, {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kernelSize</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sigma</span>,
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// @ts-ignore
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>self</span>.<span style=color:#a6e22e>postMessage</span>({ <span style=color:#a6e22e>taskId</span>, <span style=color:#a6e22e>result</span>: <span style=color:#66d9ef>output.buffer</span>, <span style=color:#a6e22e>width</span>, <span style=color:#a6e22e>height</span> }, [
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>output</span>.<span style=color:#a6e22e>buffer</span>,
</span></span><span style=display:flex><span>  ]);
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>然后修改下上面的<code>startGaussianBlur</code>方法，在页面上创建并调用这个<code>Worker</code>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-tsx data-lang=tsx><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>startGaussianBlur</span> <span style=color:#f92672>=</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>now</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>performance</span>.<span style=color:#a6e22e>now</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  document.<span style=color:#a6e22e>querySelectorAll</span>(<span style=color:#e6db74>&#34;canvas&#34;</span>).<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>canvas</span>, <span style=color:#a6e22e>idx</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ctx</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>getContext</span>(<span style=color:#e6db74>&#34;2d&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>width</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>width</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>height</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>canvas</span>.<span style=color:#a6e22e>height</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>imageData</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ctx</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>getImageData</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>width</span>, <span style=color:#a6e22e>height</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>buffer</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>imageData</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>buffer</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>worker</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Worker</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>URL</span>(<span style=color:#e6db74>&#34;./worker&#34;</span>, <span style=color:#66d9ef>import</span>.<span style=color:#a6e22e>meta</span>.<span style=color:#a6e22e>url</span>), {<span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;module&#34;</span>});
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#a6e22e>worker</span>.<span style=color:#a6e22e>onmessage</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>e</span>: <span style=color:#66d9ef>MessageEvent</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>      <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>result</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>data</span>;
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>      <span style=color:#a6e22e>ctx</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>putImageData</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ImageData</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Uint8ClampedArray</span>(<span style=color:#a6e22e>result</span>), <span style=color:#a6e22e>width</span>, <span style=color:#a6e22e>height</span>), <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    }
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#a6e22e>worker</span>.<span style=color:#a6e22e>postMessage</span>({
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>      <span style=color:#a6e22e>taskId</span>: <span style=color:#66d9ef>idx</span>,
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>      <span style=color:#a6e22e>payload</span>: <span style=color:#66d9ef>buffer</span>,
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>      <span style=color:#a6e22e>width</span>,
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>      <span style=color:#a6e22e>height</span>,
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>      <span style=color:#a6e22e>kernelSize</span>: <span style=color:#66d9ef>7</span>,
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>      <span style=color:#a6e22e>sigma</span>: <span style=color:#66d9ef>1.5</span>,
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>  })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`timing:, </span><span style=color:#e6db74>${</span>(<span style=color:#a6e22e>performance</span>.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>-</span> <span style=color:#a6e22e>now</span>) <span style=color:#f92672>/</span> <span style=color:#ae81ff>1000</span><span style=color:#e6db74>}</span><span style=color:#e6db74>s`</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>}
</span></span></code></pre></div><p>注意下，这里对<code>Worker</code>实例化时的方式，使用<code>webpack</code>或<code>vite</code>打包的项目，路径是相对当前js文件的路径，而不是相对HTML页面的路径。如果直接<code>new Worker('./worker')</code> 实际执行时会<code>404</code>。并且由于worker中使用了<code>import</code>，需要在第二个参数中指定<code>type: 'module'</code>。</p><p>再点击按钮看下效果，BOOM！时间一下缩短到了<code>0.049s</code>，<code>INP</code>也来到了<code>88ms</code>。
<img alt=inp loading=lazy src=/posts/arraybuffer/images/inp-metric.png></p><p>其实，还有优化空间。不知道你注意到没有，我们这里为每张图片都创建了一个单独的<code>Worker</code>，这样，总共就会创建十个<code>Worker</code>。这样显然是不可取的，本文开头提到，创建<code>Worker</code>是有性能开销的，不可能为一个任务单独创建一个<code>Worker</code>。</p><p>针对这一点，我们可以增加一个额外的<code>线程池</code>，让<code>Worker</code>得以重复使用。</p><p>线程池的代码就不贴在本文了，因为有些偏离主题，如果感兴趣可以<a href=https://github.com/weita0/address-book/blob/main/app/routes/webworker/pool.ts>点这里查看代码</a>。</p><p>增加线程池后，我们用3个<code>Worker</code>实例来处理十张图片，用时是<code>0.036s</code>，<code>INP</code>来到<code>80ms</code>，可以看到并不比启用十个<code>Worker</code>慢，并且性能开销肯定小得多。</p><h2 id=结语>结语<a hidden class=anchor aria-hidden=true href=#结语>#</a></h2><p>回到主题，buffer在<code>Woker</code>和主线程之间通信，是被<code>转移</code>而不是被<code>拷贝</code>。那么如何验证呢。</p><p>还记得文章开头引用的MDN吗，被转移后的buffer，<code>detached</code>属性会变为true，意味着内存已经和引用分离，因此<code>length</code>也会变为0。让我们来实际验证下。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-tsx data-lang=tsx><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>applyGaussianBlur</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;./gaussian&#34;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#a6e22e>self</span>.<span style=color:#a6e22e>onmessage</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>e</span>: <span style=color:#66d9ef>MessageEvent</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  <span style=color:#66d9ef>const</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#a6e22e>taskId</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#a6e22e>payload</span>: <span style=color:#66d9ef>buffer</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#a6e22e>width</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#a6e22e>height</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#a6e22e>kernelSize</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>7</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#a6e22e>sigma</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1.5</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>  } <span style=color:#f92672>=</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>data</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>input</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Uint8ClampedArray</span>(<span style=color:#a6e22e>buffer</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>output</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Uint8ClampedArray</span>(<span style=color:#a6e22e>input</span>.<span style=color:#a6e22e>length</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>  
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>group</span>(<span style=color:#e6db74>&#39;before&#39;</span>);
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;detached ?&#39;</span>, <span style=color:#a6e22e>output</span>.<span style=color:#a6e22e>buffer</span>.<span style=color:#a6e22e>detached</span>);
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;  length ?&#39;</span>, <span style=color:#a6e22e>output</span>.<span style=color:#a6e22e>buffer</span>.<span style=color:#a6e22e>byteLength</span>);
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>groupEnd</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>  <span style=color:#a6e22e>applyGaussianBlur</span>(<span style=color:#a6e22e>input</span>, <span style=color:#a6e22e>output</span>, <span style=color:#a6e22e>width</span>, <span style=color:#a6e22e>height</span>, {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    <span style=color:#a6e22e>kernelSize</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    <span style=color:#a6e22e>sigma</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>  });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>  <span style=color:#75715e>// @ts-ignore
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#75715e></span>  <span style=color:#a6e22e>self</span>.<span style=color:#a6e22e>postMessage</span>({ <span style=color:#a6e22e>taskId</span>, <span style=color:#a6e22e>result</span>: <span style=color:#66d9ef>output.buffer</span>, <span style=color:#a6e22e>width</span>, <span style=color:#a6e22e>height</span> }, [
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    <span style=color:#a6e22e>output</span>.<span style=color:#a6e22e>buffer</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>  ]);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>group</span>(<span style=color:#e6db74>&#39;after&#39;</span>);
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;detached ?&#39;</span>, <span style=color:#a6e22e>output</span>.<span style=color:#a6e22e>buffer</span>.<span style=color:#a6e22e>detached</span>);
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;  length ?&#39;</span>, <span style=color:#a6e22e>output</span>.<span style=color:#a6e22e>buffer</span>.<span style=color:#a6e22e>byteLength</span>);
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>groupEnd</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>};
</span></span></code></pre></div><p><img alt=output loading=lazy src=/posts/arraybuffer/images/log.png></p><p>符合预期！</p><p>至此，咱们是否可以说「No one knows ArrayBuffer better than me」了？（手动狗头）（End）</p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://weita0.github.io/>Restart | 重开</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>