<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>副作用 | Restart | 重开</title><meta name=keywords content="React"><meta name=description content="React中的副作用"><meta name=author content><link rel=canonical href=https://weita0.github.io/posts/%E5%89%AF%E4%BD%9C%E7%94%A8/><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://weita0.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://weita0.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://weita0.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://weita0.github.io/apple-touch-icon.png><link rel=mask-icon href=https://weita0.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://weita0.github.io/posts/%E5%89%AF%E4%BD%9C%E7%94%A8/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://weita0.github.io/posts/%E5%89%AF%E4%BD%9C%E7%94%A8/"><meta property="og:site_name" content="Restart | 重开"><meta property="og:title" content="副作用"><meta property="og:description" content="React中的副作用"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-06-04T10:00:30+08:00"><meta property="article:modified_time" content="2025-06-04T10:00:30+08:00"><meta property="article:tag" content="React"><meta name=twitter:card content="summary"><meta name=twitter:title content="副作用"><meta name=twitter:description content="React中的副作用"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://weita0.github.io/posts/"},{"@type":"ListItem","position":2,"name":"副作用","item":"https://weita0.github.io/posts/%E5%89%AF%E4%BD%9C%E7%94%A8/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"副作用","name":"副作用","description":"React中的副作用","keywords":["React"],"articleBody":"什么是副作用？ 副作用（side effect）指的是调用函数时，除了返回值外，对主调用函数产生的附加影响。\n比如修改函数外的变量，事件订阅，数据获取，修改DOM。\n在React中，可以使用useEffect和useLayoutEffect和useInsertionEffect三种hook来声明组件的副作用。\n三种hook的具体区别可以参考React官方文档，这里不再赘述。\n在React Fiber架构下，effect分为收集（render）和执行（commit）两个阶段。在收集阶段，收集信息，构建链表。在执行阶段，执行实际的副作用函数和清理函数。\nrender阶段 在render阶段，React会为每个副作用单独创建一个hook对象，并以链表（linked list）的形式保存在Fiber节点的memoizedState字段上。\n1export type Fiber = { 2 memoizedState: any, 3 // A queue of state updates and callbacks 4 updateQueue: mixed, 5 // ... 6} 结合源码来看下useEffect的具体实现。\n1// react-reconciler/src/ReactFiberHooks 2 3// 当前fiber的hook链表 4let currentHook: Hook | null = null; 5// 更新中的hook链表 6let workInProgressHook: Hook | null = null; 7 8// `mountEffect` 即 `useEffect` 9function mountEffect( 10 create: () =\u003e (() =\u003e void) | void, 11 deps: Array\u003cmixed\u003e | void | null, 12): void { 13 mountEffectImpl( 14 PassiveEffect | PassiveStaticEffect, // fiber上的标记，待会会加到fiber.flags上 15 HookPassive, // effect上的tag，表示这个hook的类型 16 create, // useEffect里定义的函数 17 deps, // useEffect依赖项 18 ) 19} 20 21function mountEffectImpl( 22 fiberFlags: Flags, 23 hookFlags: HookFlags, 24 create: () =\u003e (() =\u003e void) | void, 25 deps: Array\u003cmixed\u003e | void | null, 26): void { 27 // 构造一个新的hook容器，并把上一个hook的next指向它(如果为空，就把它当作起始的hook，并保存在fiber的memoizedState上，具体的实现在后面)。 28 const hook = mountWorkInProgressHook(); 29 const nextDeps = deps === undefined ? null : deps; 30 // 给fiber节点打上effect标记 31 currentlyRenderingFiber.flags |= fiberFlags; 32 // 调用pushSimpleEffect将effect信息保存在当前hook的`memoizedState`上。 33 // 注意hook的memoizedState不仅用于保存useEffect，useState、useRef等其他hook也存在这条链上。 34 // 具体的实现请往后看。 35 hook.memoizedState = pushSimpleEffect( 36 HookHasEffect | hookFlags, 37 createEffectInstance(), 38 create, 39 nextDeps, 40 ); 41} 42// 创建effect实例：一个包含destroy属性的对象 43function createEffectInstance(): EffectInstance { 44 return {destroy: undefined}; 45} 46 47function pushSimpleEffect( 48 tag: HookFlags, 49 inst: EffectInstance, 50 create: () =\u003e (() =\u003e void) | void, 51 deps: Array\u003cmixed\u003e | void | null, 52): Effect { 53 // 初始化一个effect容器，用于保存create、deps和实例信息。 54 const effect: Effect = { 55 tag, 56 create, 57 deps, 58 inst, 59 // Circular 60 next: (null: any), 61 }; 62 return pushEffectImpl(effect); 63} 64 65function pushEffectImpl(effect: Effect): Effect { 66 // `updateQueue`专门用于存储当前fiber节点的副作用，也是链式结构 67 // `updateQueue`包含一个`lastEffect`属性，指向当前fiber节点的最后一个effect对象 68 let componentUpdateQueue: null | FunctionComponentUpdateQueue = 69 (currentlyRenderingFiber.updateQueue: any); 70 // 如果为空，创建一个空的`updateQueue`对象，并挂载到fiber上。 71 if (componentUpdateQueue === null) { 72 componentUpdateQueue = createFunctionComponentUpdateQueue(); 73 currentlyRenderingFiber.updateQueue = (componentUpdateQueue: any); 74 } 75 const lastEffect = componentUpdateQueue.lastEffect; 76 if (lastEffect === null) { 77 // 如果lastEffect指向为空，就指向传入的effect，并把该effect的next指向自身（为了成环） 78 componentUpdateQueue.lastEffect = effect.next = effect; 79 } else { 80 // 如果不为空，把updateQueue.lastEffect指向传入的effect，并把该effect的next指向链表的第一个effect 81 // 也就是lastEffect.next 原先指向的effect。 82 const firstEffect = lastEffect.next; 83 lastEffect.next = effect; 84 effect.next = firstEffect; 85 componentUpdateQueue.lastEffect = effect; 86 } 87 return effect; 88} 89 90// updateQueue的类型定义 91// react-reconciler/src/ReactFiberHooks 92export type FunctionComponentUpdateQueue = { 93 lastEffect: Effect | null, 94 events: Array\u003cEventFunctionPayload\u003cany, any, any\u003e\u003e | null, 95 stores: Array\u003cStoreConsistencyCheck\u003cany\u003e\u003e | null, 96 memoCache: MemoCache | null, 97}; pushEffectImpl的逻辑看起来有些绕，简单来说，节点上的effect是个环形链，updateQueue永远指向最后一个effect，这个effect又有一个next属性指向第一个effect。每次插入新的effect，都会插在最后，也就是updateQueue.lastEffect。\n1// 初始化hook的方法 2function mountWorkInProgressHook(): Hook { 3 const hook: Hook = { 4 memoizedState: null, 5 baseState: null, 6 baseQueue: null, 7 queue: null, 8 next: null, 9 }; 10 if (workInProgressHook === null) { 11 // This is the first hook in the list 12 currentlyRenderingFiber.memoizedState = workInProgressHook = hook; 13 } else { 14 // Append to the end of the list 15 workInProgressHook = workInProgressHook.next = hook; 16 } 17 return workInProgressHook; 18} commit阶段 在commit阶段执行副作用，让我们结合源码来试图理解一下这个过程。\n// react-reconciler/src/ReactFiberCommitEffects export function commitHookEffectListMount( flags: HookFlags, finishedWork: Fiber, ) { try { const updateQueue= finishedWork.updateQueue; const lastEffect = updateQueue !== null ? updateQueue.lastEffect : null; if (lastEffect !== null) { const firstEffect = lastEffect.next; let effect = firstEffect; do { let destroy; const create = effect.create; const inst = effect.inst; destroy = create(); // 执行副作用并得到cleanup方法 inst.destroy = destroy; /** * 开发模式下，这里会对destroy做一次类型检查，并额外运行一次。 * 如果你的useEffect返回值是null或者promise，都会引发警告⚠️ * 严格来说，只要你的返回值里包含then方法，就会被视作promise。 */ effect = effect.next; // 循环调用，直到指针指向自己 } while (effect !== firstEffect); } } catch (error) { // 错误处理 } } 很简洁很直观，是不是。\n组件卸载时的处理和上面极为相似，只不过把调用create改为了调用destroy。\n结语 最后看一眼effect hook相关的flags定义。\n// react-reconciler/src/ReactHookEffectTags export type HookFlags = number; export const NoFlags = /* */ 0b0000; export const HasEffect = /* */ 0b0001; export const Insertion = /* */ 0b0010; export const Layout = /* */ 0b0100; export const Passive = /* */ 0b1000; 和表示fiber的标记类型一样，都是二进制数。\n（End）\n","wordCount":"598","inLanguage":"en","datePublished":"2025-06-04T10:00:30+08:00","dateModified":"2025-06-04T10:00:30+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://weita0.github.io/posts/%E5%89%AF%E4%BD%9C%E7%94%A8/"},"publisher":{"@type":"Organization","name":"Restart | 重开","logo":{"@type":"ImageObject","url":"https://weita0.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://weita0.github.io/ accesskey=h title="Restart | 重开 (Alt + H)">Restart | 重开</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">副作用</h1><div class=post-description>React中的副作用</div><div class=post-meta><span title='2025-06-04 10:00:30 +0800 CST'>June 4, 2025</span></div><br><ul class=post-tags><li><a href=https://weita0.github.io/tags/react/>React</a></li></ul></header><div class=post-content><h2 id=什么是副作用>什么是副作用？<a hidden class=anchor aria-hidden=true href=#什么是副作用>#</a></h2><p>副作用（side effect）指的是调用函数时，除了返回值外，对主调用函数产生的附加影响。</p><p>比如修改函数外的变量，事件订阅，数据获取，修改DOM。</p><p>在React中，可以使用<code>useEffect</code>和<code>useLayoutEffect</code>和<code>useInsertionEffect</code>三种hook来声明组件的副作用。</p><p>三种hook的具体区别可以参考React官方文档，这里不再赘述。</p><p>在React Fiber架构下，effect分为收集（render）和执行（commit）两个阶段。在收集阶段，收集信息，构建链表。在执行阶段，执行实际的副作用函数和清理函数。</p><h2 id=render阶段>render阶段<a hidden class=anchor aria-hidden=true href=#render阶段>#</a></h2><p>在<code>render</code>阶段，React会为每个副作用单独创建一个hook对象，并以链表（linked list）的形式保存在Fiber节点的<code>memoizedState</code>字段上。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Fiber</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>  <span style=color:#a6e22e>memoizedState</span>: <span style=color:#66d9ef>any</span>,
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>  <span style=color:#75715e>// A queue of state updates and callbacks
</span></span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#75715e></span>  <span style=color:#a6e22e>updateQueue</span>: <span style=color:#66d9ef>mixed</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>  <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>结合源码来看下<code>useEffect</code>的具体实现。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#75715e>// react-reconciler/src/ReactFiberHooks
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#75715e>// 当前fiber的hook链表
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#75715e></span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>currentHook</span>: <span style=color:#66d9ef>Hook</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#75715e>// 更新中的hook链表
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#75715e></span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>workInProgressHook</span>: <span style=color:#66d9ef>Hook</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#75715e>// `mountEffect` 即 `useEffect`
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>mountEffect</span>(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  <span style=color:#a6e22e>create</span><span style=color:#f92672>:</span> () <span style=color:#f92672>=&gt;</span> (() <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>void</span>) <span style=color:#f92672>|</span> <span style=color:#66d9ef>void</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>  <span style=color:#a6e22e>deps</span>: <span style=color:#66d9ef>Array</span>&lt;<span style=color:#f92672>mixed</span>&gt; <span style=color:#f92672>|</span> <span style=color:#66d9ef>void</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>  <span style=color:#a6e22e>mountEffectImpl</span>(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#a6e22e>PassiveEffect</span> <span style=color:#f92672>|</span> <span style=color:#a6e22e>PassiveStaticEffect</span>, <span style=color:#75715e>// fiber上的标记，待会会加到fiber.flags上
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#75715e></span>    <span style=color:#a6e22e>HookPassive</span>, <span style=color:#75715e>// effect上的tag，表示这个hook的类型
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#75715e></span>    <span style=color:#a6e22e>create</span>, <span style=color:#75715e>// useEffect里定义的函数
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#75715e></span>    <span style=color:#a6e22e>deps</span>, <span style=color:#75715e>// useEffect依赖项
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#75715e></span>  )
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>mountEffectImpl</span>(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>  <span style=color:#a6e22e>fiberFlags</span>: <span style=color:#66d9ef>Flags</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>  <span style=color:#a6e22e>hookFlags</span>: <span style=color:#66d9ef>HookFlags</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>  <span style=color:#a6e22e>create</span><span style=color:#f92672>:</span> () <span style=color:#f92672>=&gt;</span> (() <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>void</span>) <span style=color:#f92672>|</span> <span style=color:#66d9ef>void</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>  <span style=color:#a6e22e>deps</span>: <span style=color:#66d9ef>Array</span>&lt;<span style=color:#f92672>mixed</span>&gt; <span style=color:#f92672>|</span> <span style=color:#66d9ef>void</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>  <span style=color:#75715e>// 构造一个新的hook容器，并把上一个hook的next指向它(如果为空，就把它当作起始的hook，并保存在fiber的memoizedState上，具体的实现在后面)。
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>hook</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>mountWorkInProgressHook</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>nextDeps</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>deps</span> <span style=color:#f92672>===</span> <span style=color:#66d9ef>undefined</span> <span style=color:#f92672>?</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>:</span> <span style=color:#a6e22e>deps</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>  <span style=color:#75715e>// 给fiber节点打上effect标记
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#75715e></span>  <span style=color:#a6e22e>currentlyRenderingFiber</span>.<span style=color:#a6e22e>flags</span> <span style=color:#f92672>|=</span> <span style=color:#a6e22e>fiberFlags</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>  <span style=color:#75715e>// 调用pushSimpleEffect将effect信息保存在当前hook的`memoizedState`上。
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#75715e></span>  <span style=color:#75715e>// 注意hook的memoizedState不仅用于保存useEffect，useState、useRef等其他hook也存在这条链上。
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#75715e></span>  <span style=color:#75715e>// 具体的实现请往后看。
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#75715e></span>  <span style=color:#a6e22e>hook</span>.<span style=color:#a6e22e>memoizedState</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>pushSimpleEffect</span>(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>    <span style=color:#a6e22e>HookHasEffect</span> <span style=color:#f92672>|</span> <span style=color:#a6e22e>hookFlags</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>    <span style=color:#a6e22e>createEffectInstance</span>(),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>    <span style=color:#a6e22e>create</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>    <span style=color:#a6e22e>nextDeps</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>  );
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span><span style=color:#75715e>// 创建effect实例：一个包含destroy属性的对象
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>createEffectInstance</span>()<span style=color:#f92672>:</span> <span style=color:#a6e22e>EffectInstance</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>  <span style=color:#66d9ef>return</span> {<span style=color:#a6e22e>destroy</span>: <span style=color:#66d9ef>undefined</span>};
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>pushSimpleEffect</span>(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>  <span style=color:#a6e22e>tag</span>: <span style=color:#66d9ef>HookFlags</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>  <span style=color:#a6e22e>inst</span>: <span style=color:#66d9ef>EffectInstance</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>  <span style=color:#a6e22e>create</span><span style=color:#f92672>:</span> () <span style=color:#f92672>=&gt;</span> (() <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>void</span>) <span style=color:#f92672>|</span> <span style=color:#66d9ef>void</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>  <span style=color:#a6e22e>deps</span>: <span style=color:#66d9ef>Array</span>&lt;<span style=color:#f92672>mixed</span>&gt; <span style=color:#f92672>|</span> <span style=color:#66d9ef>void</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Effect</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>  <span style=color:#75715e>// 初始化一个effect容器，用于保存create、deps和实例信息。
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>effect</span>: <span style=color:#66d9ef>Effect</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>    <span style=color:#a6e22e>tag</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>    <span style=color:#a6e22e>create</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>    <span style=color:#a6e22e>deps</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>    <span style=color:#a6e22e>inst</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>    <span style=color:#75715e>// Circular
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span><span style=color:#75715e></span>    <span style=color:#a6e22e>next</span><span style=color:#f92672>:</span> (<span style=color:#66d9ef>null</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>any</span>),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>  };
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>pushEffectImpl</span>(<span style=color:#a6e22e>effect</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>pushEffectImpl</span>(<span style=color:#a6e22e>effect</span>: <span style=color:#66d9ef>Effect</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Effect</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>  <span style=color:#75715e>// `updateQueue`专门用于存储当前fiber节点的副作用，也是链式结构
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span><span style=color:#75715e></span>  <span style=color:#75715e>// `updateQueue`包含一个`lastEffect`属性，指向当前fiber节点的最后一个effect对象
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68</span><span><span style=color:#75715e></span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>componentUpdateQueue</span>: <span style=color:#66d9ef>null</span> <span style=color:#f92672>|</span> <span style=color:#a6e22e>FunctionComponentUpdateQueue</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69</span><span>    (<span style=color:#a6e22e>currentlyRenderingFiber.updateQueue</span>: <span style=color:#66d9ef>any</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70</span><span>  <span style=color:#75715e>// 如果为空，创建一个空的`updateQueue`对象，并挂载到fiber上。
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71</span><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>componentUpdateQueue</span> <span style=color:#f92672>===</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72</span><span>    <span style=color:#a6e22e>componentUpdateQueue</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createFunctionComponentUpdateQueue</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73</span><span>    <span style=color:#a6e22e>currentlyRenderingFiber</span>.<span style=color:#a6e22e>updateQueue</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>componentUpdateQueue</span>: <span style=color:#66d9ef>any</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75</span><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>lastEffect</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>componentUpdateQueue</span>.<span style=color:#a6e22e>lastEffect</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76</span><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>lastEffect</span> <span style=color:#f92672>===</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77</span><span>    <span style=color:#75715e>// 如果lastEffect指向为空，就指向传入的effect，并把该effect的next指向自身（为了成环）
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78</span><span><span style=color:#75715e></span>    <span style=color:#a6e22e>componentUpdateQueue</span>.<span style=color:#a6e22e>lastEffect</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>effect</span>.<span style=color:#a6e22e>next</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>effect</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79</span><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80</span><span>    <span style=color:#75715e>// 如果不为空，把updateQueue.lastEffect指向传入的effect，并把该effect的next指向链表的第一个effect
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81</span><span><span style=color:#75715e></span>    <span style=color:#75715e>// 也就是lastEffect.next 原先指向的effect。
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82</span><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>firstEffect</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>lastEffect</span>.<span style=color:#a6e22e>next</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83</span><span>    <span style=color:#a6e22e>lastEffect</span>.<span style=color:#a6e22e>next</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>effect</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">84</span><span>    <span style=color:#a6e22e>effect</span>.<span style=color:#a6e22e>next</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>firstEffect</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">85</span><span>    <span style=color:#a6e22e>componentUpdateQueue</span>.<span style=color:#a6e22e>lastEffect</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>effect</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">86</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">87</span><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>effect</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">88</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">89</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">90</span><span><span style=color:#75715e>// updateQueue的类型定义
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">91</span><span><span style=color:#75715e>// react-reconciler/src/ReactFiberHooks
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">92</span><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>FunctionComponentUpdateQueue</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">93</span><span>  <span style=color:#a6e22e>lastEffect</span>: <span style=color:#66d9ef>Effect</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">94</span><span>  <span style=color:#a6e22e>events</span>: <span style=color:#66d9ef>Array</span>&lt;<span style=color:#f92672>EventFunctionPayload</span>&lt;<span style=color:#f92672>any</span>, <span style=color:#a6e22e>any</span>, <span style=color:#a6e22e>any</span>&gt;&gt; <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">95</span><span>  <span style=color:#a6e22e>stores</span>: <span style=color:#66d9ef>Array</span>&lt;<span style=color:#f92672>StoreConsistencyCheck</span>&lt;<span style=color:#f92672>any</span>&gt;&gt; <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">96</span><span>  <span style=color:#a6e22e>memoCache</span>: <span style=color:#66d9ef>MemoCache</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">97</span><span>};
</span></span></code></pre></div><p><code>pushEffectImpl</code>的逻辑看起来有些绕，简单来说，节点上的effect是个环形链，<code>updateQueue</code>永远指向最后一个effect，这个effect又有一个next属性指向第一个effect。每次插入新的effect，都会插在最后，也就是<code>updateQueue.lastEffect</code>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#75715e>// 初始化hook的方法
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>mountWorkInProgressHook</span>()<span style=color:#f92672>:</span> <span style=color:#a6e22e>Hook</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>hook</span>: <span style=color:#66d9ef>Hook</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#a6e22e>memoizedState</span>: <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#a6e22e>baseState</span>: <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#a6e22e>baseQueue</span>: <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#a6e22e>queue</span>: <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#a6e22e>next</span>: <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  };
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>workInProgressHook</span> <span style=color:#f92672>===</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#75715e>// This is the first hook in the list
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#75715e></span>    <span style=color:#a6e22e>currentlyRenderingFiber</span>.<span style=color:#a6e22e>memoizedState</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>workInProgressHook</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>hook</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#75715e>// Append to the end of the list
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#75715e></span>    <span style=color:#a6e22e>workInProgressHook</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>workInProgressHook</span>.<span style=color:#a6e22e>next</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>hook</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>workInProgressHook</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>}
</span></span></code></pre></div><h2 id=commit阶段>commit阶段<a hidden class=anchor aria-hidden=true href=#commit阶段>#</a></h2><p>在<code>commit</code>阶段执行副作用，让我们结合源码来试图理解一下这个过程。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#75715e>// react-reconciler/src/ReactFiberCommitEffects
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>commitHookEffectListMount</span>(
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>flags</span>: <span style=color:#66d9ef>HookFlags</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>finishedWork</span>: <span style=color:#66d9ef>Fiber</span>,
</span></span><span style=display:flex><span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>updateQueue</span><span style=color:#f92672>=</span> <span style=color:#a6e22e>finishedWork</span>.<span style=color:#a6e22e>updateQueue</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>lastEffect</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>updateQueue</span> <span style=color:#f92672>!==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>updateQueue.lastEffect</span> : <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>lastEffect</span> <span style=color:#f92672>!==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>firstEffect</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>lastEffect</span>.<span style=color:#a6e22e>next</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>effect</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>firstEffect</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>do</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>destroy</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>create</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>effect</span>.<span style=color:#a6e22e>create</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>inst</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>effect</span>.<span style=color:#a6e22e>inst</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>destroy</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>create</span>(); <span style=color:#75715e>// 执行副作用并得到cleanup方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>inst</span>.<span style=color:#a6e22e>destroy</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>destroy</span>;
</span></span><span style=display:flex><span>        <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * 开发模式下，这里会对destroy做一次类型检查，并额外运行一次。
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * 如果你的useEffect返回值是null或者promise，都会引发警告⚠️
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * 严格来说，只要你的返回值里包含then方法，就会被视作promise。
</span></span></span><span style=display:flex><span><span style=color:#75715e>         */</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>effect</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>effect</span>.<span style=color:#a6e22e>next</span>;
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 循环调用，直到指针指向自己
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      } <span style=color:#66d9ef>while</span> (<span style=color:#a6e22e>effect</span> <span style=color:#f92672>!==</span> <span style=color:#a6e22e>firstEffect</span>);
</span></span><span style=display:flex><span>    } 
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 错误处理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>很简洁很直观，是不是。</p><p>组件卸载时的处理和上面极为相似，只不过把调用<code>create</code>改为了调用<code>destroy</code>。</p><h2 id=结语>结语<a hidden class=anchor aria-hidden=true href=#结语>#</a></h2><p>最后看一眼effect hook相关的flags定义。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#75715e>// react-reconciler/src/ReactHookEffectTags
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>HookFlags</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>NoFlags</span> <span style=color:#f92672>=</span> <span style=color:#75715e>/*   */</span> <span style=color:#ae81ff>0</span><span style=color:#a6e22e>b0000</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>HasEffect</span> <span style=color:#f92672>=</span> <span style=color:#75715e>/* */</span> <span style=color:#ae81ff>0</span><span style=color:#a6e22e>b0001</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Insertion</span> <span style=color:#f92672>=</span> <span style=color:#75715e>/* */</span> <span style=color:#ae81ff>0</span><span style=color:#a6e22e>b0010</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Layout</span> <span style=color:#f92672>=</span> <span style=color:#75715e>/*    */</span> <span style=color:#ae81ff>0</span><span style=color:#a6e22e>b0100</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Passive</span> <span style=color:#f92672>=</span> <span style=color:#75715e>/*   */</span> <span style=color:#ae81ff>0</span><span style=color:#a6e22e>b1000</span>;
</span></span></code></pre></div><p>和表示fiber的标记类型一样，都是二进制数。</p><p>（End）</p></div><footer class=post-footer></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://weita0.github.io/>Restart | 重开</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>