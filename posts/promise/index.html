<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Promise (上) | Restart | 重开</title><meta name=keywords content><meta name=description content="如何优雅地实现Promise API"><meta name=author content><link rel=canonical href=https://weita0.github.io/posts/promise/><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://weita0.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://weita0.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://weita0.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://weita0.github.io/apple-touch-icon.png><link rel=mask-icon href=https://weita0.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://weita0.github.io/posts/promise/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://weita0.github.io/posts/promise/"><meta property="og:site_name" content="Restart | 重开"><meta property="og:title" content="Promise (上)"><meta property="og:description" content="如何优雅地实现Promise API"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-06-10T00:00:00+00:00"><meta property="article:modified_time" content="2025-06-10T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Promise (上)"><meta name=twitter:description content="如何优雅地实现Promise API"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://weita0.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Promise (上)","item":"https://weita0.github.io/posts/promise/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Promise (上)","name":"Promise (上)","description":"如何优雅地实现Promise API","keywords":[],"articleBody":"引子 作为JavaScript开发者，Promise可以说是我们的工具库中最最基础的工具之一了，如果你不仅仅满足于能够熟练使用这个趁手的工具，那么这篇文章就是为你准备的。\n规范 首先，让我们来看一下Promises/A+ —— 一个专门制订Promise规范的组织 —— 给出的Promise规范。规范之所以重要，是因为我们的实现要严格根据规范来。如果你认为自己已经足够了解Promise API了，或者觉得上来就看规范过于枯燥，那么也可以先跳过这部分，结合具体的实现来看，也是可以的。\n1. 相关术语 promise is an object or function with a then method whose behavior conforms to this specification.\npromise是拥有符合规范的then方法的对象或函数。 thenable is an object or function that defines a then method.\nthenable指定义了then方法的对象或函数。 value is any legal JavaScript value(including undefined, a thenable, or a promise).\nvalue可以是任何合法的JavaScript值，包括undefined。 exception is a value that is thrown using the throw statement.\nexception是通过throw语句抛出的一个值。 reason is a value that indicates why a promise was rejected.\nreason表示promise失败的原因。 2. 要求 2.1 状态 一个Promise只能是pending、fulfilled、rejected三种状态（其一）。\n2.1.1. pending状态可以转为另外两种状态\n2.1.2. fulfilled状态下\n2.1.2.1. promise不能再转为其他状态\n2.1.2.2. fulfilled状态必须有值(value)，并且这个值不能变\n2.1.3. rejected状态也不能再转为其他状态，必须要有reason，并且也不能变\n2.2. then方法 then方法接收两个参数：\npromise.then(onFulfilled, onRejected) 2.2.1. 这两个参数都是可选的，并且如果传入值不是函数，应该被忽略。\n2.2.2. 当onFulfilled是一个函数时\n2.2.2.1. 当promise状态为fulfilled时调用onFulfilled，并把value作为第一个参数。\n2.2.2.2. 不能在状态变为fulfilled前调用。\n2.2.2.3. 不能被调用多次\n2.2.3. onRejected同理\n…\n…\nthen具有几个基本特征：\n必须返回一个promise then可以被同一个promise调用多次，并且onFulfilled和onRejected的执行要符合then被调用的顺序。 2.3. Promise Solution Procedure 这个部分是关于promise resolve或reject之后在各种情形下的处理。\n为了直观，这里我直接用具体的例子来进行说明。\nlet p = new Promise(resolve =\u003e { resolve(p); }); 2.3.1. resolve的value如果指向自身，reject这个promise，reason为TypeError\nlet p = new Promise(resolve =\u003e { let p2 = new Promise(resovle =\u003e { resolve('x'); }) resolve(p2); }) p.then(res =\u003e { console.log(res); // -\u003e x, instead of p2 }) 2.3.2. resolve的value如果为另一个promise，那么接受这个promise的状态作为当前Promise的状态。\nlet p = new Promise(resolve =\u003e { resolve({ then: function() { console.log('x'); } }); }); 2.3.3.1. value如果为一个thenable的函数，等同于\nlet p = new Promise(resolve =\u003e { resolve(undefined); }) .then(() =\u003e { console.log('x'); // -\u003e x }); 实现 有了指导准则，让我们来动手实现一个minimal promise吧。\n下面这个实现，参考了yaku 这个库给出的实现 —— 一个非常简洁（核心代码只有80行） 并且可读性很强的promise实现（非常推荐读一下源码）。yaku的实现基于function + 原型链，这里我采用了更为现代的class语法。\n1// 规范2.1. Promise只能是以下三种状态：fulfilled(resolved) / rejected / pending 2const $rejected = 0; 3const $resolved = 1; 4const $pending = 2; 5 6class MyPromise { 7 // new Promise时的唯一参数 8 // function executor((value?: any) =\u003e void, (reason?: any) =\u003e void) =\u003e void; 9 constructor(executor) { 10 // 初始状态为pending 11 this.state = $pending; 12 // resolved value 13 this.value = undefined; 14 // rejected reason 15 this.reason = undefined; 16 // 规范里，then方法可以被同一个Promise多次调用，并且回调要符合then被调用的顺序，并且then要返回一个新的promise 17 // 这里把通过调用then方法得到的promise挂在[count]属性上（注意，是count的值，而非count本身，然后count++），执行时按照从0到[count]的顺序执行 18 this.count = 0; 19 // resolved callback：状态从pending变为fulfilled时的回调 20 this.onFulfilled = () =\u003e {}; 21 // rejected callback：状态从pending变为rejected时的回调 22 this.onRejected = () =\u003e {}; 23 24 executor(this.genSettle($resolved), this.genSettle($rejected)) 25 } 26 27 genSettle(state) { 28 return (value) =\u003e this.settlePromise(state, value); 29 } 30 31 settlePromise(state, value) { 32 // 规范2.2.1. 状态只能从pending 变为resolved或rejected，且只能改变一次 33 if (this.state !== $pending) return; 34 35 this.state = state; 36 this.value = value; 37 38 let i = 0, 39 len = this.count; 40 // 依次调用then方法 41 while (i \u003c len) { 42 this.scheduleHandler(this[i++]); 43 } 44 return this; 45 } 46 47 // then的具体实现 48 addhandler(next, onFulfilled, onRejected) { 49 if (typeof onFulfilled === \"function\") { 50 next.onFulfilled = onFulfilled; 51 } 52 if (typeof onRejected === \"function\") { 53 next.onRejected = onRejected; 54 } 55 // 当前Promise的状态如果是pending，则先把promise挂载在当前Promise的[count]属性上，等待执行 56 // 如果状态是resoled或rejected，直接执行 57 if (this.state === $pending) { 58 this[this.count++] = next; 59 } else { 60 // 执行阶段 61 this.scheduleHandler(next); 62 } 63 return next; 64 } 65 66 scheduleHandler(next) { 67 // setTimeout模拟微任务（即同步任务执行完成后再执行） 68 return setTimeout(() =\u003e { 69 let x, 70 handler = this.state === $resolved ? next.onFulfilled : next.onRejected; // 如果Promise状态是resolved，执行onFulfilled回调，如果是rejected，执行onRejected回调 71 // 如果onFulfilled或onRejected不是函数，用当前Promise的的state和value 作为next的state和value（规范2.2.7.3、2.2.7.4） 72 if (handler === undefined) { 73 next.settlePromise(this.state, this.value); 74 return; 75 } 76 try { 77 // 执行实际的promise并得到返回值x 78 x = handler(this.value); 79 } catch (err) { 80 next.settlePromise($rejected, err); 81 return; 82 } 83 // 处理x 84 next.settleWithX(x); 85 }); 86 } 87 settleWithX(x) { 88 // 禁止循环引用 -\u003e resolve或reject传入Promise自身（规范2.3.1.） 89 if (this === x) { 90 this.settlePromise($rejected, new TypeError(\"promise_circular_chain\")); 91 return; 92 } 93 let xthen, 94 type = typeof x; 95 // 规范2.3.3. 96 // 如果x是函数或对象，用x.then作为当前Promise的then 97 if (type === \"function\" || type === \"object\") { 98 try { 99 xthen = x.then; 100 if (typeof xthen === \"function\") { 101 // 如果x.then是函数的处理 102 this.settleXthen(x, xthen); 103 } else { 104 // 如果是对象，用x作为Promise resolve后的value 105 this.settlePromise($resolved, x); 106 } 107 } catch (err) { 108 this.settlePromise($rejected, err); 109 } 110 } else { 111 this.settlePromise($resolved, x); 112 } 113 return this; 114 } 115 settleXthen(x, xthen) { 116 try { 117 // 调用x.then，且this 指向x（规范2.3.3.3.） 118 xthen.call(x, function(y) { 119 if(!x) return 120 x = null; 121 122 this.settleWithX(y); 123 }, function (r) { 124 if (!x) return; 125 x = null; 126 127 this.settlePromise($rejected, r); 128 }) 129 } catch(err) { 130 if (x) { 131 this.settlePromise($rejected, err); 132 x = null; 133 } 134 } 135 } 136 then(onFulfilled, onRejected) { 137 this.addhandler(new MyPromise(function () {}), onFulfilled, onRejected); 138 } 139} 以上，就是一个minimal Promise的实现，支持最基本的Promise用法，支持then的链式调用，支持同一个Promise上注册多次then回调，不妨先试试。\n…\n…\n等一下，上面的实现虽然能用，但是不是缺了点啥。\n没错，规范本身并没有定义catch和finally方法。\n让我们来动手加上这两个方法。\n1class MyPromise { 2 catch(onRejected) { 3 this.then(undefined, onRejected) 4 } 5 6 finally(onFinally) { 7 return this.then( 8 value =\u003e MyPromise.resolve(onFinally()).then(() =\u003e value), 9 reason =\u003e MyPromise.resolve(onFinally()).then(() =\u003e throw reason), 10 ) 11 } 12} 看到没，本质上就是对then方法的包装和扩展。\n","wordCount":"742","inLanguage":"en","datePublished":"2025-06-10T00:00:00Z","dateModified":"2025-06-10T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://weita0.github.io/posts/promise/"},"publisher":{"@type":"Organization","name":"Restart | 重开","logo":{"@type":"ImageObject","url":"https://weita0.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://weita0.github.io/ accesskey=h title="Restart | 重开 (Alt + H)">Restart | 重开</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Promise (上)</h1><div class=post-description>如何优雅地实现Promise API</div><div class=post-meta><span title='2025-06-10 00:00:00 +0000 UTC'>June 10, 2025</span></div><br><ul class=post-tags></ul></header><div class=post-content><h2 id=引子>引子<a hidden class=anchor aria-hidden=true href=#引子>#</a></h2><p>作为JavaScript开发者，Promise可以说是我们的工具库中最最基础的工具之一了，如果你不仅仅满足于能够熟练使用这个趁手的工具，那么这篇文章就是为你准备的。</p><h2 id=规范>规范<a hidden class=anchor aria-hidden=true href=#规范>#</a></h2><p>首先，让我们来看一下<a href=https://promisesaplus.com/>Promises/A+</a> —— 一个专门制订Promise规范的组织 —— 给出的Promise规范。规范之所以重要，是因为我们的实现要严格根据规范来。如果你认为自己已经足够了解Promise API了，或者觉得上来就看规范过于枯燥，那么也可以先跳过这部分，结合具体的<a href=/posts/promise/#%E5%AE%9E%E7%8E%B0>实现</a>来看，也是可以的。</p><h3 id=1-相关术语>1. 相关术语<a hidden class=anchor aria-hidden=true href=#1-相关术语>#</a></h3><blockquote><ol><li><code>promise</code> is an object or function with a <code>then</code> method whose behavior conforms to this specification.<br><code>promise</code>是拥有符合规范的<code>then</code>方法的对象或函数。</li><li><code>thenable</code> is an object or function that defines a <code>then</code> method.<br><code>thenable</code>指定义了<code>then</code>方法的对象或函数。</li><li><code>value</code> is any legal JavaScript value(including <code>undefined</code>, a <code>thenable</code>, or a promise).<br><code>value</code>可以是任何合法的JavaScript值，包括<code>undefined</code>。</li><li><code>exception</code> is a value that is thrown using the <code>throw</code> statement.<br><code>exception</code>是通过<code>throw</code>语句抛出的一个值。</li><li><code>reason</code> is a value that indicates why a promise was rejected.<br><code>reason</code>表示promise失败的原因。</li></ol></blockquote><h3 id=2-要求>2. 要求<a hidden class=anchor aria-hidden=true href=#2-要求>#</a></h3><h4 id=21-状态>2.1 状态<a hidden class=anchor aria-hidden=true href=#21-状态>#</a></h4><p>一个Promise只能是<code>pending</code>、<code>fulfilled</code>、<code>rejected</code>三种状态（其一）。</p><blockquote><p>2.1.1. <code>pending</code>状态可以转为另外两种状态</p></blockquote><blockquote><p>2.1.2. <code>fulfilled</code>状态下</p><blockquote><p>2.1.2.1. <code>promise</code>不能再转为其他状态<br>2.1.2.2. <code>fulfilled</code>状态必须有值(<code>value</code>)，并且这个值不能变</p></blockquote></blockquote><blockquote><p>2.1.3. <code>rejected</code>状态也不能再转为其他状态，必须要有<code>reason</code>，并且也不能变</p></blockquote><h4 id=22-then方法>2.2. <code>then</code>方法<a hidden class=anchor aria-hidden=true href=#22-then方法>#</a></h4><p><code>then</code>方法接收两个参数：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>promise</span>.<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>onFulfilled</span>, <span style=color:#a6e22e>onRejected</span>)
</span></span></code></pre></div><blockquote><p>2.2.1. 这两个参数都是可选的，并且如果传入值不是函数，应该被忽略。</p></blockquote><blockquote><p>2.2.2. 当<code>onFulfilled</code>是一个函数时</p><blockquote><p>2.2.2.1. 当promise状态为<code>fulfilled</code>时调用<code>onFulfilled</code>，并把<code>value</code>作为第一个参数。<br>2.2.2.2. 不能在状态变为<code>fulfilled</code>前调用。<br>2.2.2.3. 不能被调用多次</p></blockquote></blockquote><blockquote><p>2.2.3. <code>onRejected</code>同理</p></blockquote><p>&mldr;</p><p>&mldr;</p><p><code>then</code>具有几个基本特征：</p><ol><li>必须返回一个<code>promise</code></li><li><code>then</code>可以被同一个<code>promise</code>调用多次，并且<code>onFulfilled</code>和<code>onRejected</code>的执行要符合<code>then</code>被调用的顺序。</li></ol><h3 id=23-promise-solution-procedure>2.3. Promise Solution Procedure<a hidden class=anchor aria-hidden=true href=#23-promise-solution-procedure>#</a></h3><p>这个部分是关于promise resolve或reject之后在各种情形下的处理。<br>为了直观，这里我直接用具体的例子来进行说明。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>p</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Promise(<span style=color:#a6e22e>resolve</span> =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>p</span>);
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>2.3.1. <code>resolve</code>的<code>value</code>如果指向自身，<code>reject</code>这个<code>promise</code>，reason为<code>TypeError</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>p</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Promise(<span style=color:#a6e22e>resolve</span> =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>p2</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Promise(<span style=color:#a6e22e>resovle</span> =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>resolve</span>(<span style=color:#e6db74>&#39;x&#39;</span>);
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>p2</span>);
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span><span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>res</span> =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>res</span>); <span style=color:#75715e>// -&gt; x, instead of p2
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>})
</span></span></code></pre></div><p>2.3.2. <code>resolve</code>的<code>value</code>如果为另一个promise，那么接受这个promise的状态作为当前Promise的状态。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>p</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Promise(<span style=color:#a6e22e>resolve</span> =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resolve</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>then</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span>() {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;x&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>2.3.3.1. <code>value</code>如果为一个<code>thenable</code>的函数，等同于</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>p</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Promise(<span style=color:#a6e22e>resolve</span> =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>resolve</span>(<span style=color:#66d9ef>undefined</span>);
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>then</span>(() =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;x&#39;</span>); <span style=color:#75715e>// -&gt; x
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  });
</span></span></code></pre></div><h2 id=实现>实现<a hidden class=anchor aria-hidden=true href=#实现>#</a></h2><p>有了指导准则，让我们来动手实现一个<code>minimal promise</code>吧。</p><p>下面这个实现，参考了<a href=https://github.com/ysmood/yaku/blob/master/src/yaku.aplus.js>yaku</a> 这个库给出的实现 —— 一个非常简洁（核心代码只有80行） 并且可读性很强的<code>promise</code>实现（非常推荐读一下源码）。yaku的实现基于<code>function</code> + 原型链，这里我采用了更为现代的<code>class</code>语法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1</span><span><span style=color:#75715e>// 规范2.1. Promise只能是以下三种状态：fulfilled(resolved) / rejected / pending
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2</span><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>$rejected</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3</span><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>$resolved</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4</span><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>$pending</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6</span><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyPromise</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7</span><span>  <span style=color:#75715e>// new Promise时的唯一参数
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8</span><span><span style=color:#75715e></span>  <span style=color:#75715e>// function executor((value?: any) =&gt; void, (reason?: any) =&gt; void) =&gt; void;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9</span><span><span style=color:#75715e></span>  <span style=color:#66d9ef>constructor</span>(<span style=color:#a6e22e>executor</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10</span><span>    <span style=color:#75715e>// 初始状态为pending
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11</span><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>$pending</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12</span><span>    <span style=color:#75715e>// resolved value
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13</span><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>value</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>undefined</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14</span><span>    <span style=color:#75715e>// rejected reason
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15</span><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>reason</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>undefined</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16</span><span>    <span style=color:#75715e>// 规范里，then方法可以被同一个Promise多次调用，并且回调要符合then被调用的顺序，并且then要返回一个新的promise
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17</span><span><span style=color:#75715e></span>    <span style=color:#75715e>// 这里把通过调用then方法得到的promise挂在[count]属性上（注意，是count的值，而非count本身，然后count++），执行时按照从0到[count]的顺序执行
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18</span><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>count</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19</span><span>    <span style=color:#75715e>// resolved callback：状态从pending变为fulfilled时的回调
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20</span><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>onFulfilled</span> <span style=color:#f92672>=</span> () <span style=color:#f92672>=&gt;</span> {};
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21</span><span>    <span style=color:#75715e>// rejected callback：状态从pending变为rejected时的回调
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22</span><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>onRejected</span> <span style=color:#f92672>=</span> () <span style=color:#f92672>=&gt;</span> {};
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24</span><span>    <span style=color:#a6e22e>executor</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>genSettle</span>(<span style=color:#a6e22e>$resolved</span>), <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>genSettle</span>(<span style=color:#a6e22e>$rejected</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27</span><span>  <span style=color:#a6e22e>genSettle</span>(<span style=color:#a6e22e>state</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28</span><span>    <span style=color:#66d9ef>return</span> (<span style=color:#a6e22e>value</span>) <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>settlePromise</span>(<span style=color:#a6e22e>state</span>, <span style=color:#a6e22e>value</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31</span><span>  <span style=color:#a6e22e>settlePromise</span>(<span style=color:#a6e22e>state</span>, <span style=color:#a6e22e>value</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32</span><span>    <span style=color:#75715e>// 规范2.2.1. 状态只能从pending 变为resolved或rejected，且只能改变一次
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33</span><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>!==</span> <span style=color:#a6e22e>$pending</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35</span><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>state</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36</span><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>value</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>value</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38</span><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39</span><span>      <span style=color:#a6e22e>len</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>count</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40</span><span>    <span style=color:#75715e>// 依次调用then方法
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41</span><span><span style=color:#75715e></span>    <span style=color:#66d9ef>while</span> (<span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>len</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42</span><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>scheduleHandler</span>(<span style=color:#66d9ef>this</span>[<span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>]);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44</span><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47</span><span>  <span style=color:#75715e>// then的具体实现
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48</span><span><span style=color:#75715e></span>  <span style=color:#a6e22e>addhandler</span>(<span style=color:#a6e22e>next</span>, <span style=color:#a6e22e>onFulfilled</span>, <span style=color:#a6e22e>onRejected</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49</span><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>typeof</span> <span style=color:#a6e22e>onFulfilled</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;function&#34;</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50</span><span>      <span style=color:#a6e22e>next</span>.<span style=color:#a6e22e>onFulfilled</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>onFulfilled</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52</span><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>typeof</span> <span style=color:#a6e22e>onRejected</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;function&#34;</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53</span><span>      <span style=color:#a6e22e>next</span>.<span style=color:#a6e22e>onRejected</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>onRejected</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55</span><span>    <span style=color:#75715e>// 当前Promise的状态如果是pending，则先把promise挂载在当前Promise的[count]属性上，等待执行
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56</span><span><span style=color:#75715e></span>    <span style=color:#75715e>// 如果状态是resoled或rejected，直接执行
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57</span><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>$pending</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58</span><span>      <span style=color:#66d9ef>this</span>[<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>count</span><span style=color:#f92672>++</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>next</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59</span><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60</span><span>      <span style=color:#75715e>// 执行阶段
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61</span><span><span style=color:#75715e></span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>scheduleHandler</span>(<span style=color:#a6e22e>next</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63</span><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>next</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66</span><span>  <span style=color:#a6e22e>scheduleHandler</span>(<span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67</span><span>    <span style=color:#75715e>// setTimeout模拟微任务（即同步任务执行完成后再执行）
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68</span><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>setTimeout</span>(() <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69</span><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>x</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70</span><span>        <span style=color:#a6e22e>handler</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>$resolved</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>next.onFulfilled</span> : <span style=color:#66d9ef>next.onRejected</span>; <span style=color:#75715e>// 如果Promise状态是resolved，执行onFulfilled回调，如果是rejected，执行onRejected回调
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71</span><span><span style=color:#75715e></span>      <span style=color:#75715e>// 如果onFulfilled或onRejected不是函数，用当前Promise的的state和value 作为next的state和value（规范2.2.7.3、2.2.7.4）
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72</span><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>handler</span> <span style=color:#f92672>===</span> <span style=color:#66d9ef>undefined</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73</span><span>        <span style=color:#a6e22e>next</span>.<span style=color:#a6e22e>settlePromise</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>state</span>, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>value</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74</span><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75</span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76</span><span>      <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77</span><span>        <span style=color:#75715e>// 执行实际的promise并得到返回值x
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78</span><span><span style=color:#75715e></span>        <span style=color:#a6e22e>x</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>handler</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>value</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79</span><span>      } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80</span><span>        <span style=color:#a6e22e>next</span>.<span style=color:#a6e22e>settlePromise</span>(<span style=color:#a6e22e>$rejected</span>, <span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81</span><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82</span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83</span><span>      <span style=color:#75715e>// 处理x
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84</span><span><span style=color:#75715e></span>      <span style=color:#a6e22e>next</span>.<span style=color:#a6e22e>settleWithX</span>(<span style=color:#a6e22e>x</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85</span><span>    });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87</span><span>  <span style=color:#a6e22e>settleWithX</span>(<span style=color:#a6e22e>x</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88</span><span>    <span style=color:#75715e>// 禁止循环引用 -&gt; resolve或reject传入Promise自身（规范2.3.1.）
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89</span><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>x</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90</span><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>settlePromise</span>(<span style=color:#a6e22e>$rejected</span>, <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TypeError</span>(<span style=color:#e6db74>&#34;promise_circular_chain&#34;</span>));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91</span><span>      <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93</span><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>xthen</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94</span><span>      <span style=color:#66d9ef>type</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>typeof</span> <span style=color:#a6e22e>x</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95</span><span>    <span style=color:#75715e>// 规范2.3.3.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96</span><span><span style=color:#75715e></span>    <span style=color:#75715e>// 如果x是函数或对象，用x.then作为当前Promise的then
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97</span><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>type</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;function&#34;</span> <span style=color:#f92672>||</span> <span style=color:#66d9ef>type</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;object&#34;</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98</span><span>      <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99</span><span>        <span style=color:#a6e22e>xthen</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>x</span>.<span style=color:#a6e22e>then</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100</span><span>        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>typeof</span> <span style=color:#a6e22e>xthen</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;function&#34;</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101</span><span>          <span style=color:#75715e>// 如果x.then是函数的处理
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102</span><span><span style=color:#75715e></span>          <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>settleXthen</span>(<span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>xthen</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103</span><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104</span><span>          <span style=color:#75715e>// 如果是对象，用x作为Promise resolve后的value
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105</span><span><span style=color:#75715e></span>          <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>settlePromise</span>(<span style=color:#a6e22e>$resolved</span>, <span style=color:#a6e22e>x</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107</span><span>      } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108</span><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>settlePromise</span>(<span style=color:#a6e22e>$rejected</span>, <span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109</span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110</span><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111</span><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>settlePromise</span>(<span style=color:#a6e22e>$resolved</span>, <span style=color:#a6e22e>x</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113</span><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115</span><span>  <span style=color:#a6e22e>settleXthen</span>(<span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>xthen</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116</span><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117</span><span>      <span style=color:#75715e>// 调用x.then，且this 指向x（规范2.3.3.3.）
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118</span><span><span style=color:#75715e></span>      <span style=color:#a6e22e>xthen</span>.<span style=color:#a6e22e>call</span>(<span style=color:#a6e22e>x</span>, <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>y</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119</span><span>        <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>x</span>) <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120</span><span>        <span style=color:#a6e22e>x</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121</span><span>        
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122</span><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>settleWithX</span>(<span style=color:#a6e22e>y</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123</span><span>      }, <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>r</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124</span><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>x</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125</span><span>        <span style=color:#a6e22e>x</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126</span><span>        
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127</span><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>settlePromise</span>(<span style=color:#a6e22e>$rejected</span>, <span style=color:#a6e22e>r</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128</span><span>      })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129</span><span>    } <span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130</span><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>x</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131</span><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>settlePromise</span>(<span style=color:#a6e22e>$rejected</span>, <span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132</span><span>        <span style=color:#a6e22e>x</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133</span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">136</span><span>  <span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>onFulfilled</span>, <span style=color:#a6e22e>onRejected</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">137</span><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>addhandler</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>MyPromise</span>(<span style=color:#66d9ef>function</span> () {}), <span style=color:#a6e22e>onFulfilled</span>, <span style=color:#a6e22e>onRejected</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">138</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">139</span><span>}
</span></span></code></pre></div><p>以上，就是一个<code>minimal Promise</code>的实现，支持最基本的<code>Promise</code>用法，支持<code>then</code>的链式调用，支持同一个<code>Promise</code>上注册多次<code>then</code>回调，不妨先试试。</p><p>&mldr;</p><p>&mldr;</p><p>等一下，上面的实现虽然能用，但是不是缺了点啥。</p><p>没错，规范本身并没有定义<code>catch</code>和<code>finally</code>方法。</p><p>让我们来动手加上这两个方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyPromise</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>onRejected</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>then</span>(<span style=color:#66d9ef>undefined</span>, <span style=color:#a6e22e>onRejected</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>  <span style=color:#66d9ef>finally</span>(<span style=color:#a6e22e>onFinally</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>then</span>(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>      <span style=color:#a6e22e>value</span> =&gt; <span style=color:#a6e22e>MyPromise</span>.<span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>onFinally</span>()).<span style=color:#a6e22e>then</span>(() =&gt; <span style=color:#a6e22e>value</span>),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>      <span style=color:#a6e22e>reason</span> =&gt; <span style=color:#a6e22e>MyPromise</span>.<span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>onFinally</span>()).<span style=color:#a6e22e>then</span>(() =&gt; <span style=color:#66d9ef>throw</span> <span style=color:#a6e22e>reason</span>),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    )
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>}
</span></span></code></pre></div><p>看到没，本质上就是对<code>then</code>方法的包装和扩展。</p></div><footer class=post-footer></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://weita0.github.io/>Restart | 重开</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>