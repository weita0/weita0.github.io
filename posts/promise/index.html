<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Promise (ä¸Š) | Restart | é‡å¼€</title><meta name=keywords content><meta name=description content="å¦‚ä½•ä¼˜é›…åœ°å®ç°Promise API"><meta name=author content><link rel=canonical href=https://weita0.github.io/posts/promise/><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://weita0.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://weita0.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://weita0.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://weita0.github.io/apple-touch-icon.png><link rel=mask-icon href=https://weita0.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://weita0.github.io/posts/promise/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://weita0.github.io/posts/promise/"><meta property="og:site_name" content="Restart | é‡å¼€"><meta property="og:title" content="Promise (ä¸Š)"><meta property="og:description" content="å¦‚ä½•ä¼˜é›…åœ°å®ç°Promise API"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-06-13T00:00:00+00:00"><meta property="article:modified_time" content="2025-06-13T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Promise (ä¸Š)"><meta name=twitter:description content="å¦‚ä½•ä¼˜é›…åœ°å®ç°Promise API"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://weita0.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Promise (ä¸Š)","item":"https://weita0.github.io/posts/promise/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Promise (ä¸Š)","name":"Promise (ä¸Š)","description":"å¦‚ä½•ä¼˜é›…åœ°å®ç°Promise API","keywords":[],"articleBody":"å¼•å­ ä½œä¸ºJavaScriptå¼€å‘è€…ï¼ŒPromiseå¯ä»¥è¯´æ˜¯æˆ‘ä»¬çš„å·¥å…·åº“ä¸­æœ€æœ€åŸºç¡€çš„å·¥å…·ä¹‹ä¸€äº†ï¼Œå¦‚æœä½ ä¸ä»…ä»…æ»¡è¶³äºèƒ½å¤Ÿç†Ÿç»ƒä½¿ç”¨è¿™ä¸ªè¶æ‰‹çš„å·¥å…·ï¼Œé‚£ä¹ˆè¿™ç¯‡æ–‡ç« å°±æ˜¯ä¸ºä½ å‡†å¤‡çš„ã€‚\nè§„èŒƒ é¦–å…ˆï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹Promises/A+ â€”â€” ä¸€ä¸ªä¸“é—¨åˆ¶è®¢Promiseè§„èŒƒçš„ç»„ç»‡ â€”â€” ç»™å‡ºçš„Promiseè§„èŒƒã€‚è§„èŒƒä¹‹æ‰€ä»¥é‡è¦ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬çš„å®ç°è¦ä¸¥æ ¼æ ¹æ®è§„èŒƒæ¥ã€‚å¦‚æœä½ è®¤ä¸ºè‡ªå·±å·²ç»è¶³å¤Ÿäº†è§£Promise APIäº†ï¼Œæˆ–è€…è§‰å¾—ä¸Šæ¥å°±çœ‹è§„èŒƒè¿‡äºæ¯ç‡¥ï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥å…ˆè·³è¿‡è¿™éƒ¨åˆ†ï¼Œç»“åˆå…·ä½“çš„å®ç°æ¥çœ‹ï¼Œä¹Ÿæ˜¯å¯ä»¥çš„ã€‚\n1. ç›¸å…³æœ¯è¯­ promise is an object or function with a then method whose behavior conforms to this specification.\npromiseæ˜¯æ‹¥æœ‰ç¬¦åˆè§„èŒƒçš„thenæ–¹æ³•çš„å¯¹è±¡æˆ–å‡½æ•°ã€‚ thenable is an object or function that defines a then method.\nthenableæŒ‡å®šä¹‰äº†thenæ–¹æ³•çš„å¯¹è±¡æˆ–å‡½æ•°ã€‚ value is any legal JavaScript value(including undefined, a thenable, or a promise).\nvalueå¯ä»¥æ˜¯ä»»ä½•åˆæ³•çš„JavaScriptå€¼ï¼ŒåŒ…æ‹¬undefinedã€‚ exception is a value that is thrown using the throw statement.\nexceptionæ˜¯é€šè¿‡throwè¯­å¥æŠ›å‡ºçš„ä¸€ä¸ªå€¼ã€‚ reason is a value that indicates why a promise was rejected.\nreasonè¡¨ç¤ºpromiseå¤±è´¥çš„åŸå› ã€‚ 2. è¦æ±‚ 2.1 çŠ¶æ€ ä¸€ä¸ªPromiseåªèƒ½æ˜¯pendingã€fulfilledã€rejectedä¸‰ç§çŠ¶æ€ï¼ˆå…¶ä¸€ï¼‰ã€‚\n2.1.1. pendingçŠ¶æ€å¯ä»¥è½¬ä¸ºå¦å¤–ä¸¤ç§çŠ¶æ€\n2.1.2. fulfilledçŠ¶æ€ä¸‹\n2.1.2.1. promiseä¸èƒ½å†è½¬ä¸ºå…¶ä»–çŠ¶æ€\n2.1.2.2. fulfilledçŠ¶æ€å¿…é¡»æœ‰å€¼(value)ï¼Œå¹¶ä¸”è¿™ä¸ªå€¼ä¸èƒ½å˜\n2.1.3. rejectedçŠ¶æ€ä¹Ÿä¸èƒ½å†è½¬ä¸ºå…¶ä»–çŠ¶æ€ï¼Œå¿…é¡»è¦æœ‰reasonï¼Œå¹¶ä¸”ä¹Ÿä¸èƒ½å˜\n2.2. thenæ–¹æ³• thenæ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼š\npromise.then(onFulfilled, onRejected) 2.2.1. è¿™ä¸¤ä¸ªå‚æ•°éƒ½æ˜¯å¯é€‰çš„ï¼Œå¹¶ä¸”å¦‚æœä¼ å…¥å€¼ä¸æ˜¯å‡½æ•°ï¼Œåº”è¯¥è¢«å¿½ç•¥ã€‚\n2.2.2. å½“onFulfilledæ˜¯ä¸€ä¸ªå‡½æ•°æ—¶\n2.2.2.1. å½“promiseçŠ¶æ€ä¸ºfulfilledæ—¶è°ƒç”¨onFulfilledï¼Œå¹¶æŠŠvalueä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ã€‚\n2.2.2.2. ä¸èƒ½åœ¨çŠ¶æ€å˜ä¸ºfulfilledå‰è°ƒç”¨ã€‚\n2.2.2.3. ä¸èƒ½è¢«è°ƒç”¨å¤šæ¬¡\n2.2.3. onRejectedåŒç†\nâ€¦\nâ€¦\nthenå…·æœ‰å‡ ä¸ªåŸºæœ¬ç‰¹å¾ï¼š\nå¿…é¡»è¿”å›ä¸€ä¸ªpromise thenå¯ä»¥è¢«åŒä¸€ä¸ªpromiseè°ƒç”¨å¤šæ¬¡ï¼Œå¹¶ä¸”onFulfilledå’ŒonRejectedçš„æ‰§è¡Œè¦ç¬¦åˆthenè¢«è°ƒç”¨çš„é¡ºåºã€‚ 2.3. Promise Solution Procedure è¿™ä¸ªéƒ¨åˆ†æ˜¯å…³äºpromise resolveæˆ–rejectä¹‹ååœ¨å„ç§æƒ…å½¢ä¸‹çš„å¤„ç†ã€‚\nä¸ºäº†ç›´è§‚ï¼Œè¿™é‡Œæˆ‘ç›´æ¥ç”¨å…·ä½“çš„ä¾‹å­æ¥è¿›è¡Œè¯´æ˜ã€‚\nlet self = new Promise(resolve =\u003e { setTimeout(() =\u003e { resolve(self); }) }); 2.3.1. resolveçš„valueå¦‚æœæŒ‡å‘è‡ªèº«ï¼Œrejectè¿™ä¸ªpromiseï¼Œreasonä¸ºTypeError\nlet p = new Promise(resolve =\u003e { let p2 = new Promise(resovle =\u003e { resolve('x'); }) resolve(p2); }) p.then(res =\u003e { console.log(res); // -\u003e x, instead of p2 }) 2.3.2. resolvedçš„valueå¦‚æœä¸ºå¦ä¸€ä¸ªpromiseï¼Œé‚£ä¹ˆæ¥å—è¿™ä¸ªpromiseçš„çŠ¶æ€ä½œä¸ºå½“å‰Promiseçš„çŠ¶æ€ã€‚\nnew Promise((resolve) =\u003e { resolve({ greeting: \"hi\", then: function (onFulfilled, onRejected) { onFulfilled(this.greeting); }, }); }).then((res) =\u003e { console.log(res); // -\u003e 'hi' }); new Promise((resolve) =\u003e { resolve({ reason: \"it went wrong!\", then: function (_, onRejected) { onRejected(this.reason); }, }); }).catch((err) =\u003e { console.log(err); // -\u003e it went wrong! }); 2.3.3.3. resolvedçš„valueæ˜¯xï¼Œå¦‚æœxæ˜¯å¯¹è±¡ï¼Œä¸”æœ‰thenæ–¹æ³•ï¼Œè°ƒç”¨x.thenå¹¶æŠŠthisæŒ‡å‘xã€‚è°ƒç”¨x.thenæ—¶çš„ç¬¬ä¸€ä¸ªå‚æ•°resolvePromiseï¼Œç¬¬äºŒä¸ªå‚æ•°rejectPromiseï¼Œå½“resolvePromiseè¢«è°ƒç”¨å¹¶ä¼ å…¥yï¼Œç”¨yæ¥resolveè¿™ä¸ªpromiseï¼Œå½“rejectPromiseè¢«è°ƒç”¨å¹¶ä¼ å…¥rï¼Œç”¨ræ¥rejectè¿™ä¸ªpromiseã€‚\nå®ç° æœ‰äº†æŒ‡å¯¼å‡†åˆ™ï¼Œè®©æˆ‘ä»¬æ¥åŠ¨æ‰‹å®ç°ä¸€ä¸ªminimal promiseå§ã€‚\nä¸‹é¢è¿™ä¸ªå®ç°ï¼Œå‚è€ƒäº†yaku è¿™ä¸ªåº“ç»™å‡ºçš„å®ç° â€”â€” ä¸€ä¸ªéå¸¸ç®€æ´ï¼ˆæ ¸å¿ƒä»£ç åªæœ‰80è¡Œï¼‰ å¹¶ä¸”å¯è¯»æ€§å¾ˆå¼ºçš„promiseå®ç°ï¼ˆéå¸¸æ¨èè¯»ä¸€ä¸‹æºç ï¼‰ã€‚yakuçš„å®ç°åŸºäºfunction + åŸå‹é“¾ï¼Œè¿™é‡Œæˆ‘é‡‡ç”¨äº†æ›´ä¸ºç°ä»£çš„classè¯­æ³•ã€‚\n1// è§„èŒƒ2.1. Promiseåªèƒ½æ˜¯ä»¥ä¸‹ä¸‰ç§çŠ¶æ€ï¼šfulfilled(resolved) / rejected / pending 2const $rejected = 0; 3const $resolved = 1; 4const $pending = 2; 5 6class MyPromise { 7 // new Promiseæ—¶çš„å”¯ä¸€å‚æ•°ï¼Œå‡½æ•°ç­¾åä¸ºğŸ‘‡ 8 // function executor((value?: any) =\u003e void, (reason?: any) =\u003e void) =\u003e void; 9 constructor(executor) { 10 // åˆå§‹çŠ¶æ€ä¸ºpending 11 this.state = $pending; 12 // resolved value 13 this.value = undefined; 14 // rejected reason 15 this.reason = undefined; 16 // è§„èŒƒé‡Œï¼Œthenæ–¹æ³•å¯ä»¥è¢«åŒä¸€ä¸ªPromiseå¤šæ¬¡è°ƒç”¨ï¼Œå¹¶ä¸”å›è°ƒè¦ç¬¦åˆthenè¢«è°ƒç”¨çš„é¡ºåºï¼Œå¹¶ä¸”thenè¦è¿”å›ä¸€ä¸ªæ–°çš„promise 17 // è¿™é‡ŒæŠŠé€šè¿‡è°ƒç”¨thenæ–¹æ³•å¾—åˆ°çš„promiseæŒ‚åœ¨[count]å±æ€§ä¸Šï¼ˆæ³¨æ„ï¼Œæ˜¯countçš„å€¼ï¼Œè€Œécountæœ¬èº«ï¼Œç„¶åcount++ï¼‰ï¼Œæ‰§è¡Œæ—¶æŒ‰ç…§ä»0åˆ°[count]çš„é¡ºåºæ‰§è¡Œ 18 this.count = 0; 19 // resolved callbackï¼šçŠ¶æ€ä»pendingå˜ä¸ºfulfilledæ—¶çš„å›è°ƒ 20 this.onFulfilled = () =\u003e {}; 21 // rejected callbackï¼šçŠ¶æ€ä»pendingå˜ä¸ºrejectedæ—¶çš„å›è°ƒ 22 this.onRejected = () =\u003e {}; 23 24 executor(this.genSettle($resolved), this.genSettle($rejected)); 25 } 26 27 genSettle(state) { 28 return (value) =\u003e this.settlePromise(state, value); 29 } 30 31 settlePromise(state, value) { 32 // è§„èŒƒ2.2.1. çŠ¶æ€åªèƒ½ä»pending å˜ä¸ºresolvedæˆ–rejectedï¼Œä¸”åªèƒ½æ”¹å˜ä¸€æ¬¡ 33 if (this.state !== $pending) return; 34 35 this.state = state; 36 this.value = value; 37 38 let i = 0, 39 len = this.count; 40 // ä¾æ¬¡è°ƒç”¨thenæ–¹æ³• 41 while (i \u003c len) { 42 this.scheduleHandler(this[i++]); 43 } 44 return this; 45 } 46 47 // thençš„å…·ä½“å®ç° 48 addhandler(next, onFulfilled, onRejected) { 49 if (typeof onFulfilled === \"function\") { 50 next.onFulfilled = onFulfilled; 51 } 52 if (typeof onRejected === \"function\") { 53 next.onRejected = onRejected; 54 } 55 // å½“å‰Promiseçš„çŠ¶æ€å¦‚æœæ˜¯pendingï¼Œåˆ™å…ˆæŠŠpromiseæŒ‚è½½åœ¨å½“å‰Promiseçš„[count]å±æ€§ä¸Šï¼Œç­‰å¾…æ‰§è¡Œ 56 // å¦‚æœçŠ¶æ€æ˜¯resoledæˆ–rejectedï¼Œç›´æ¥æ‰§è¡Œ 57 if (this.state === $pending) { 58 this[this.count++] = next; 59 } else { 60 // æ‰§è¡Œé˜¶æ®µ 61 this.scheduleHandler(next); 62 } 63 return next; 64 } 65 66 scheduleHandler(next) { 67 // setTimeoutæ¨¡æ‹Ÿå¾®ä»»åŠ¡ï¼ˆå³åŒæ­¥ä»»åŠ¡æ‰§è¡Œå®Œæˆåå†æ‰§è¡Œï¼‰ 68 return setTimeout(() =\u003e { 69 let x, 70 handler = this.state === $resolved ? next.onFulfilled : next.onRejected; // å¦‚æœPromiseçŠ¶æ€æ˜¯resolvedï¼Œæ‰§è¡ŒonFulfilledå›è°ƒï¼Œå¦‚æœæ˜¯rejectedï¼Œæ‰§è¡ŒonRejectedå›è°ƒ 71 // å¦‚æœonFulfilledæˆ–onRejectedä¸æ˜¯å‡½æ•°ï¼Œç”¨å½“å‰Promiseçš„çš„stateå’Œvalue ä½œä¸ºnextçš„stateå’Œvalueï¼ˆè§„èŒƒ2.2.7.3ã€2.2.7.4ï¼‰ 72 if (handler === undefined) { 73 next.settlePromise(this.state, this.value); 74 return; 75 } 76 try { 77 // æ‰§è¡Œå®é™…çš„promiseå¹¶å¾—åˆ°è¿”å›å€¼x 78 x = handler(this.value); 79 } catch (err) { 80 next.settlePromise($rejected, err); 81 return; 82 } 83 // å¤„ç†x 84 next.settleWithX(x); 85 }); 86 } 87 settleWithX(x) { 88 // ç¦æ­¢å¾ªç¯å¼•ç”¨ -\u003e resolveæˆ–rejectä¼ å…¥Promiseè‡ªèº«ï¼ˆè§„èŒƒ2.3.1.ï¼‰ 89 if (this === x) { 90 this.settlePromise($rejected, new TypeError(\"promise_circular_chain\")); 91 return; 92 } 93 let xthen, 94 type = typeof x; 95 // è§„èŒƒ2.3.3. 96 // å¦‚æœxæ˜¯å‡½æ•°æˆ–å¯¹è±¡ï¼Œç”¨x.thenä½œä¸ºå½“å‰Promiseçš„then 97 if (x !== null \u0026\u0026 (type === \"function\" || type === \"object\")) { 98 try { 99 xthen = x.then; 100 if (typeof xthen === \"function\") { 101 // å¦‚æœx.thenæ˜¯å‡½æ•°çš„å¤„ç† 102 this.settleXthen(x, xthen); 103 } else { 104 // å¦‚æœæ˜¯å¯¹è±¡ï¼Œç”¨xä½œä¸ºPromise resolveåçš„value 105 this.settlePromise($resolved, x); 106 } 107 } catch (err) { 108 this.settlePromise($rejected, err); 109 } 110 } else { 111 this.settlePromise($resolved, x); 112 } 113 return this; 114 } 115 settleXthen(x, xthen) { 116 try { 117 // è°ƒç”¨x.thenï¼Œä¸”this æŒ‡å‘xï¼ˆè§„èŒƒ2.3.3.3.ï¼‰ 118 // ä¼ å‚resolvePromiseã€rejectPromise 119 xthen.call( 120 x, 121 function (y) { 122 if (!x) return; 123 x = null; 124 // ç”¨ y resolve å½“å‰çš„promise 125 this.settleWithX(y); 126 }, 127 function (r) { 128 if (!x) return; 129 x = null; 130 // ç”¨ r rejectå½“å‰çš„promise 131 this.settlePromise($rejected, r); 132 } 133 ); 134 } catch (err) { 135 if (x) { 136 this.settlePromise($rejected, err); 137 x = null; 138 } 139 } 140 } 141 then(onFulfilled, onRejected) { 142 return this.addhandler( 143 new MyPromise(function () {}), 144 onFulfilled, 145 onRejected 146 ); 147 } 148} ä»¥ä¸Šï¼Œå°±æ˜¯ä¸€ä¸ªminimal Promiseçš„å®ç°ï¼Œæ”¯æŒæœ€åŸºæœ¬çš„Promiseç”¨æ³•ï¼Œæ”¯æŒthençš„é“¾å¼è°ƒç”¨ï¼Œæ”¯æŒåŒä¸€ä¸ªPromiseä¸Šæ³¨å†Œå¤šæ¬¡thenå›è°ƒï¼Œä¸å¦¨å…ˆè¯•è¯•ã€‚\nâ€¦\nâ€¦\nç­‰ä¸€ä¸‹ï¼Œä¸Šé¢çš„å®ç°è™½ç„¶èƒ½ç”¨ï¼Œä½†æ˜¯ä¸æ˜¯ç¼ºäº†ç‚¹å•¥ã€‚\næ²¡é”™ï¼ŒA+è§„èŒƒæœ¬èº«å¹¶æ²¡æœ‰å®šä¹‰catchå’Œfinallyæ–¹æ³•ï¼Œä½†åœ¨å®é™…å¼€å‘ä¸­æ˜¯å¿…ä¸å¯å°‘çš„ã€‚\nå¥½ï¼Œé‚£ä¹ˆè®©æˆ‘ä»¬æ¥åŠ¨æ‰‹åŠ ä¸Šè¿™ä¸¤ä¸ªæ–¹æ³•ã€‚\n1class MyPromise { 2 catch(onRejected) { 3 this.then(undefined, onRejected); 4 } 5} catchå…¶å®å°±æ˜¯è°ƒç”¨thenæ–¹æ³•æ—¶åªä¼ å…¥ç¬¬äºŒä¸ªonRejectedå‚æ•°ï¼Œæœ¬è´¨ä¸Šæ˜¯è¯­æ³•ç³–ã€‚\nfinallyå®ç°ä¼šéº»çƒ¦ä¸€ç‚¹ï¼Œé¦–å…ˆæˆ‘ä»¬è¦æ”¯æŒPromise.resolveå’ŒPromise.rejectçš„ç”¨æ³•ã€‚\n1class MyPromise { 2 static resolve(value) { 3 if (value instanceof MyPromise) { 4 return value; 5 } 6 return new MyPromise((resolve) =\u003e resolve(value)); 7 } 8 9 static reject(reason) { 10 return new MyPromise((_, reject) =\u003e reject(reason)); 11 } 12 13 finally(onFinally) { 14 return this.then( 15 (value) =\u003e { 16 return MyPromise.resolve(onFinally()).then(() =\u003e value); 17 }, 18 (reason) =\u003e { 19 return MyPromise.resolve(onFinally()).then(() =\u003e { 20 throw reason; 21 }); 22 } 23 ); 24 } 25} è‡³æ­¤ï¼Œä¸€ä¸ªåŠŸèƒ½åŸºæœ¬å®Œå¤‡çš„Promise API å°±ç®—å¤§åŠŸå‘Šæˆäº†ã€‚\nä¸‹ä¸€ç¯‡æˆ‘ä»¬ä¼šæ›´æ·±å…¥ä¸€äº›ï¼Œçœ‹çœ‹Promise.raceã€Promise.allã€Promise.allSettled è¿™å‡ ä¸ªå¸¸ç”¨æ–¹æ³•çš„å®ç°åŸç†ã€‚\nï¼ˆEndï¼‰\n","wordCount":"858","inLanguage":"en","datePublished":"2025-06-13T00:00:00Z","dateModified":"2025-06-13T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://weita0.github.io/posts/promise/"},"publisher":{"@type":"Organization","name":"Restart | é‡å¼€","logo":{"@type":"ImageObject","url":"https://weita0.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://weita0.github.io/ accesskey=h title="Restart | é‡å¼€ (Alt + H)">Restart | é‡å¼€</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Promise (ä¸Š)</h1><div class=post-description>å¦‚ä½•ä¼˜é›…åœ°å®ç°Promise API</div><div class=post-meta><span title='2025-06-13 00:00:00 +0000 UTC'>June 13, 2025</span></div><br><ul class=post-tags></ul></header><div class=post-content><h2 id=å¼•å­>å¼•å­<a hidden class=anchor aria-hidden=true href=#å¼•å­>#</a></h2><p>ä½œä¸ºJavaScriptå¼€å‘è€…ï¼ŒPromiseå¯ä»¥è¯´æ˜¯æˆ‘ä»¬çš„å·¥å…·åº“ä¸­æœ€æœ€åŸºç¡€çš„å·¥å…·ä¹‹ä¸€äº†ï¼Œå¦‚æœä½ ä¸ä»…ä»…æ»¡è¶³äºèƒ½å¤Ÿç†Ÿç»ƒä½¿ç”¨è¿™ä¸ªè¶æ‰‹çš„å·¥å…·ï¼Œé‚£ä¹ˆè¿™ç¯‡æ–‡ç« å°±æ˜¯ä¸ºä½ å‡†å¤‡çš„ã€‚</p><h2 id=è§„èŒƒ>è§„èŒƒ<a hidden class=anchor aria-hidden=true href=#è§„èŒƒ>#</a></h2><p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹<a href=https://promisesaplus.com/>Promises/A+</a> â€”â€” ä¸€ä¸ªä¸“é—¨åˆ¶è®¢Promiseè§„èŒƒçš„ç»„ç»‡ â€”â€” ç»™å‡ºçš„Promiseè§„èŒƒã€‚è§„èŒƒä¹‹æ‰€ä»¥é‡è¦ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬çš„å®ç°è¦ä¸¥æ ¼æ ¹æ®è§„èŒƒæ¥ã€‚å¦‚æœä½ è®¤ä¸ºè‡ªå·±å·²ç»è¶³å¤Ÿäº†è§£Promise APIäº†ï¼Œæˆ–è€…è§‰å¾—ä¸Šæ¥å°±çœ‹è§„èŒƒè¿‡äºæ¯ç‡¥ï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥å…ˆè·³è¿‡è¿™éƒ¨åˆ†ï¼Œç»“åˆå…·ä½“çš„<a href=/posts/promise/#%E5%AE%9E%E7%8E%B0>å®ç°</a>æ¥çœ‹ï¼Œä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p><h3 id=1-ç›¸å…³æœ¯è¯­>1. ç›¸å…³æœ¯è¯­<a hidden class=anchor aria-hidden=true href=#1-ç›¸å…³æœ¯è¯­>#</a></h3><blockquote><ol><li><code>promise</code> is an object or function with a <code>then</code> method whose behavior conforms to this specification.<br><code>promise</code>æ˜¯æ‹¥æœ‰ç¬¦åˆè§„èŒƒçš„<code>then</code>æ–¹æ³•çš„å¯¹è±¡æˆ–å‡½æ•°ã€‚</li><li><code>thenable</code> is an object or function that defines a <code>then</code> method.<br><code>thenable</code>æŒ‡å®šä¹‰äº†<code>then</code>æ–¹æ³•çš„å¯¹è±¡æˆ–å‡½æ•°ã€‚</li><li><code>value</code> is any legal JavaScript value(including <code>undefined</code>, a <code>thenable</code>, or a promise).<br><code>value</code>å¯ä»¥æ˜¯ä»»ä½•åˆæ³•çš„JavaScriptå€¼ï¼ŒåŒ…æ‹¬<code>undefined</code>ã€‚</li><li><code>exception</code> is a value that is thrown using the <code>throw</code> statement.<br><code>exception</code>æ˜¯é€šè¿‡<code>throw</code>è¯­å¥æŠ›å‡ºçš„ä¸€ä¸ªå€¼ã€‚</li><li><code>reason</code> is a value that indicates why a promise was rejected.<br><code>reason</code>è¡¨ç¤ºpromiseå¤±è´¥çš„åŸå› ã€‚</li></ol></blockquote><h3 id=2-è¦æ±‚>2. è¦æ±‚<a hidden class=anchor aria-hidden=true href=#2-è¦æ±‚>#</a></h3><h4 id=21-çŠ¶æ€>2.1 çŠ¶æ€<a hidden class=anchor aria-hidden=true href=#21-çŠ¶æ€>#</a></h4><p>ä¸€ä¸ªPromiseåªèƒ½æ˜¯<code>pending</code>ã€<code>fulfilled</code>ã€<code>rejected</code>ä¸‰ç§çŠ¶æ€ï¼ˆå…¶ä¸€ï¼‰ã€‚</p><blockquote><p>2.1.1. <code>pending</code>çŠ¶æ€å¯ä»¥è½¬ä¸ºå¦å¤–ä¸¤ç§çŠ¶æ€</p></blockquote><blockquote><p>2.1.2. <code>fulfilled</code>çŠ¶æ€ä¸‹</p><blockquote><p>2.1.2.1. <code>promise</code>ä¸èƒ½å†è½¬ä¸ºå…¶ä»–çŠ¶æ€<br>2.1.2.2. <code>fulfilled</code>çŠ¶æ€å¿…é¡»æœ‰å€¼(<code>value</code>)ï¼Œå¹¶ä¸”è¿™ä¸ªå€¼ä¸èƒ½å˜</p></blockquote></blockquote><blockquote><p>2.1.3. <code>rejected</code>çŠ¶æ€ä¹Ÿä¸èƒ½å†è½¬ä¸ºå…¶ä»–çŠ¶æ€ï¼Œå¿…é¡»è¦æœ‰<code>reason</code>ï¼Œå¹¶ä¸”ä¹Ÿä¸èƒ½å˜</p></blockquote><h4 id=22-thenæ–¹æ³•>2.2. <code>then</code>æ–¹æ³•<a hidden class=anchor aria-hidden=true href=#22-thenæ–¹æ³•>#</a></h4><p><code>then</code>æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>promise</span>.<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>onFulfilled</span>, <span style=color:#a6e22e>onRejected</span>)
</span></span></code></pre></div><blockquote><p>2.2.1. è¿™ä¸¤ä¸ªå‚æ•°éƒ½æ˜¯å¯é€‰çš„ï¼Œå¹¶ä¸”å¦‚æœä¼ å…¥å€¼ä¸æ˜¯å‡½æ•°ï¼Œåº”è¯¥è¢«å¿½ç•¥ã€‚</p></blockquote><blockquote><p>2.2.2. å½“<code>onFulfilled</code>æ˜¯ä¸€ä¸ªå‡½æ•°æ—¶</p><blockquote><p>2.2.2.1. å½“promiseçŠ¶æ€ä¸º<code>fulfilled</code>æ—¶è°ƒç”¨<code>onFulfilled</code>ï¼Œå¹¶æŠŠ<code>value</code>ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ã€‚<br>2.2.2.2. ä¸èƒ½åœ¨çŠ¶æ€å˜ä¸º<code>fulfilled</code>å‰è°ƒç”¨ã€‚<br>2.2.2.3. ä¸èƒ½è¢«è°ƒç”¨å¤šæ¬¡</p></blockquote></blockquote><blockquote><p>2.2.3. <code>onRejected</code>åŒç†</p></blockquote><p>&mldr;</p><p>&mldr;</p><p><code>then</code>å…·æœ‰å‡ ä¸ªåŸºæœ¬ç‰¹å¾ï¼š</p><ol><li>å¿…é¡»è¿”å›ä¸€ä¸ª<code>promise</code></li><li><code>then</code>å¯ä»¥è¢«åŒä¸€ä¸ª<code>promise</code>è°ƒç”¨å¤šæ¬¡ï¼Œå¹¶ä¸”<code>onFulfilled</code>å’Œ<code>onRejected</code>çš„æ‰§è¡Œè¦ç¬¦åˆ<code>then</code>è¢«è°ƒç”¨çš„é¡ºåºã€‚</li></ol><h3 id=23-promise-solution-procedure>2.3. Promise Solution Procedure<a hidden class=anchor aria-hidden=true href=#23-promise-solution-procedure>#</a></h3><p>è¿™ä¸ªéƒ¨åˆ†æ˜¯å…³äºpromise resolveæˆ–rejectä¹‹ååœ¨å„ç§æƒ…å½¢ä¸‹çš„å¤„ç†ã€‚<br>ä¸ºäº†ç›´è§‚ï¼Œè¿™é‡Œæˆ‘ç›´æ¥ç”¨å…·ä½“çš„ä¾‹å­æ¥è¿›è¡Œè¯´æ˜ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>self</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Promise(<span style=color:#a6e22e>resolve</span> =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>setTimeout</span>(() =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>self</span>);
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>2.3.1. <code>resolve</code>çš„<code>value</code>å¦‚æœæŒ‡å‘è‡ªèº«ï¼Œ<code>reject</code>è¿™ä¸ª<code>promise</code>ï¼Œreasonä¸º<code>TypeError</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>p</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Promise(<span style=color:#a6e22e>resolve</span> =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>p2</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Promise(<span style=color:#a6e22e>resovle</span> =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>resolve</span>(<span style=color:#e6db74>&#39;x&#39;</span>);
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>p2</span>);
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span><span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>res</span> =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>res</span>); <span style=color:#75715e>// -&gt; x, instead of p2
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>})
</span></span></code></pre></div><p>2.3.2. <code>resolved</code>çš„<code>value</code>å¦‚æœä¸ºå¦ä¸€ä¸ªpromiseï¼Œé‚£ä¹ˆæ¥å—è¿™ä¸ªpromiseçš„çŠ¶æ€ä½œä¸ºå½“å‰Promiseçš„çŠ¶æ€ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>resolve</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resolve</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>greeting</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;hi&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>then</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>onFulfilled</span>, <span style=color:#a6e22e>onRejected</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>onFulfilled</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>greeting</span>);
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}).<span style=color:#a6e22e>then</span>((<span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>res</span>); <span style=color:#75715e>// -&gt; &#39;hi&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>resolve</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resolve</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;it went wrong!&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>then</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>onRejected</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>onRejected</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>reason</span>);
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}).<span style=color:#66d9ef>catch</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>err</span>); <span style=color:#75715e>// -&gt; it went wrong!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>});
</span></span></code></pre></div><p>2.3.3.3. <code>resolved</code>çš„<code>value</code>æ˜¯<code>x</code>ï¼Œå¦‚æœ<code>x</code>æ˜¯å¯¹è±¡ï¼Œä¸”æœ‰<code>then</code>æ–¹æ³•ï¼Œè°ƒç”¨<code>x.then</code>å¹¶æŠŠ<code>this</code>æŒ‡å‘<code>x</code>ã€‚è°ƒç”¨<code>x.then</code>æ—¶çš„ç¬¬ä¸€ä¸ªå‚æ•°<code>resolvePromise</code>ï¼Œç¬¬äºŒä¸ªå‚æ•°<code>rejectPromise</code>ï¼Œå½“<code>resolvePromise</code>è¢«è°ƒç”¨å¹¶ä¼ å…¥<code>y</code>ï¼Œç”¨<code>y</code>æ¥resolveè¿™ä¸ªpromiseï¼Œå½“<code>rejectPromise</code>è¢«è°ƒç”¨å¹¶ä¼ å…¥<code>r</code>ï¼Œç”¨<code>r</code>æ¥rejectè¿™ä¸ªpromiseã€‚</p><h2 id=å®ç°>å®ç°<a hidden class=anchor aria-hidden=true href=#å®ç°>#</a></h2><p>æœ‰äº†æŒ‡å¯¼å‡†åˆ™ï¼Œè®©æˆ‘ä»¬æ¥åŠ¨æ‰‹å®ç°ä¸€ä¸ª<code>minimal promise</code>å§ã€‚</p><p>ä¸‹é¢è¿™ä¸ªå®ç°ï¼Œå‚è€ƒäº†<a href=https://github.com/ysmood/yaku/blob/master/src/yaku.aplus.js>yaku</a> è¿™ä¸ªåº“ç»™å‡ºçš„å®ç° â€”â€” ä¸€ä¸ªéå¸¸ç®€æ´ï¼ˆæ ¸å¿ƒä»£ç åªæœ‰80è¡Œï¼‰ å¹¶ä¸”å¯è¯»æ€§å¾ˆå¼ºçš„<code>promise</code>å®ç°ï¼ˆéå¸¸æ¨èè¯»ä¸€ä¸‹æºç ï¼‰ã€‚yakuçš„å®ç°åŸºäº<code>function</code> + åŸå‹é“¾ï¼Œè¿™é‡Œæˆ‘é‡‡ç”¨äº†æ›´ä¸ºç°ä»£çš„<code>class</code>è¯­æ³•ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1</span><span><span style=color:#75715e>// è§„èŒƒ2.1. Promiseåªèƒ½æ˜¯ä»¥ä¸‹ä¸‰ç§çŠ¶æ€ï¼šfulfilled(resolved) / rejected / pending
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2</span><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>$rejected</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3</span><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>$resolved</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4</span><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>$pending</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6</span><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyPromise</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7</span><span>  <span style=color:#75715e>// new Promiseæ—¶çš„å”¯ä¸€å‚æ•°ï¼Œå‡½æ•°ç­¾åä¸ºğŸ‘‡
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8</span><span><span style=color:#75715e></span>  <span style=color:#75715e>// function executor((value?: any) =&gt; void, (reason?: any) =&gt; void) =&gt; void;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9</span><span><span style=color:#75715e></span>  <span style=color:#66d9ef>constructor</span>(<span style=color:#a6e22e>executor</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10</span><span>    <span style=color:#75715e>// åˆå§‹çŠ¶æ€ä¸ºpending
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11</span><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>$pending</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12</span><span>    <span style=color:#75715e>// resolved value
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13</span><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>value</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>undefined</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14</span><span>    <span style=color:#75715e>// rejected reason
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15</span><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>reason</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>undefined</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16</span><span>    <span style=color:#75715e>// è§„èŒƒé‡Œï¼Œthenæ–¹æ³•å¯ä»¥è¢«åŒä¸€ä¸ªPromiseå¤šæ¬¡è°ƒç”¨ï¼Œå¹¶ä¸”å›è°ƒè¦ç¬¦åˆthenè¢«è°ƒç”¨çš„é¡ºåºï¼Œå¹¶ä¸”thenè¦è¿”å›ä¸€ä¸ªæ–°çš„promise
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17</span><span><span style=color:#75715e></span>    <span style=color:#75715e>// è¿™é‡ŒæŠŠé€šè¿‡è°ƒç”¨thenæ–¹æ³•å¾—åˆ°çš„promiseæŒ‚åœ¨[count]å±æ€§ä¸Šï¼ˆæ³¨æ„ï¼Œæ˜¯countçš„å€¼ï¼Œè€Œécountæœ¬èº«ï¼Œç„¶åcount++ï¼‰ï¼Œæ‰§è¡Œæ—¶æŒ‰ç…§ä»0åˆ°[count]çš„é¡ºåºæ‰§è¡Œ
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18</span><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>count</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19</span><span>    <span style=color:#75715e>// resolved callbackï¼šçŠ¶æ€ä»pendingå˜ä¸ºfulfilledæ—¶çš„å›è°ƒ
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20</span><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>onFulfilled</span> <span style=color:#f92672>=</span> () <span style=color:#f92672>=&gt;</span> {};
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21</span><span>    <span style=color:#75715e>// rejected callbackï¼šçŠ¶æ€ä»pendingå˜ä¸ºrejectedæ—¶çš„å›è°ƒ
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22</span><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>onRejected</span> <span style=color:#f92672>=</span> () <span style=color:#f92672>=&gt;</span> {};
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24</span><span>    <span style=color:#a6e22e>executor</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>genSettle</span>(<span style=color:#a6e22e>$resolved</span>), <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>genSettle</span>(<span style=color:#a6e22e>$rejected</span>));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27</span><span>  <span style=color:#a6e22e>genSettle</span>(<span style=color:#a6e22e>state</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28</span><span>    <span style=color:#66d9ef>return</span> (<span style=color:#a6e22e>value</span>) <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>settlePromise</span>(<span style=color:#a6e22e>state</span>, <span style=color:#a6e22e>value</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31</span><span>  <span style=color:#a6e22e>settlePromise</span>(<span style=color:#a6e22e>state</span>, <span style=color:#a6e22e>value</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32</span><span>    <span style=color:#75715e>// è§„èŒƒ2.2.1. çŠ¶æ€åªèƒ½ä»pending å˜ä¸ºresolvedæˆ–rejectedï¼Œä¸”åªèƒ½æ”¹å˜ä¸€æ¬¡
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33</span><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>!==</span> <span style=color:#a6e22e>$pending</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35</span><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>state</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36</span><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>value</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>value</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38</span><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39</span><span>      <span style=color:#a6e22e>len</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>count</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40</span><span>    <span style=color:#75715e>// ä¾æ¬¡è°ƒç”¨thenæ–¹æ³•
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41</span><span><span style=color:#75715e></span>    <span style=color:#66d9ef>while</span> (<span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>len</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42</span><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>scheduleHandler</span>(<span style=color:#66d9ef>this</span>[<span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>]);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44</span><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47</span><span>  <span style=color:#75715e>// thençš„å…·ä½“å®ç°
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48</span><span><span style=color:#75715e></span>  <span style=color:#a6e22e>addhandler</span>(<span style=color:#a6e22e>next</span>, <span style=color:#a6e22e>onFulfilled</span>, <span style=color:#a6e22e>onRejected</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49</span><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>typeof</span> <span style=color:#a6e22e>onFulfilled</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;function&#34;</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50</span><span>      <span style=color:#a6e22e>next</span>.<span style=color:#a6e22e>onFulfilled</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>onFulfilled</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52</span><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>typeof</span> <span style=color:#a6e22e>onRejected</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;function&#34;</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53</span><span>      <span style=color:#a6e22e>next</span>.<span style=color:#a6e22e>onRejected</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>onRejected</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55</span><span>    <span style=color:#75715e>// å½“å‰Promiseçš„çŠ¶æ€å¦‚æœæ˜¯pendingï¼Œåˆ™å…ˆæŠŠpromiseæŒ‚è½½åœ¨å½“å‰Promiseçš„[count]å±æ€§ä¸Šï¼Œç­‰å¾…æ‰§è¡Œ
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56</span><span><span style=color:#75715e></span>    <span style=color:#75715e>// å¦‚æœçŠ¶æ€æ˜¯resoledæˆ–rejectedï¼Œç›´æ¥æ‰§è¡Œ
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57</span><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>$pending</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58</span><span>      <span style=color:#66d9ef>this</span>[<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>count</span><span style=color:#f92672>++</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>next</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59</span><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60</span><span>      <span style=color:#75715e>// æ‰§è¡Œé˜¶æ®µ
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61</span><span><span style=color:#75715e></span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>scheduleHandler</span>(<span style=color:#a6e22e>next</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63</span><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>next</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66</span><span>  <span style=color:#a6e22e>scheduleHandler</span>(<span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67</span><span>    <span style=color:#75715e>// setTimeoutæ¨¡æ‹Ÿå¾®ä»»åŠ¡ï¼ˆå³åŒæ­¥ä»»åŠ¡æ‰§è¡Œå®Œæˆåå†æ‰§è¡Œï¼‰
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68</span><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>setTimeout</span>(() <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69</span><span>      <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>x</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70</span><span>        <span style=color:#a6e22e>handler</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>$resolved</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>next.onFulfilled</span> : <span style=color:#66d9ef>next.onRejected</span>; <span style=color:#75715e>// å¦‚æœPromiseçŠ¶æ€æ˜¯resolvedï¼Œæ‰§è¡ŒonFulfilledå›è°ƒï¼Œå¦‚æœæ˜¯rejectedï¼Œæ‰§è¡ŒonRejectedå›è°ƒ
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71</span><span><span style=color:#75715e></span>      <span style=color:#75715e>// å¦‚æœonFulfilledæˆ–onRejectedä¸æ˜¯å‡½æ•°ï¼Œç”¨å½“å‰Promiseçš„çš„stateå’Œvalue ä½œä¸ºnextçš„stateå’Œvalueï¼ˆè§„èŒƒ2.2.7.3ã€2.2.7.4ï¼‰
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72</span><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>handler</span> <span style=color:#f92672>===</span> <span style=color:#66d9ef>undefined</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73</span><span>        <span style=color:#a6e22e>next</span>.<span style=color:#a6e22e>settlePromise</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>state</span>, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>value</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74</span><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75</span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76</span><span>      <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77</span><span>        <span style=color:#75715e>// æ‰§è¡Œå®é™…çš„promiseå¹¶å¾—åˆ°è¿”å›å€¼x
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78</span><span><span style=color:#75715e></span>        <span style=color:#a6e22e>x</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>handler</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>value</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79</span><span>      } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80</span><span>        <span style=color:#a6e22e>next</span>.<span style=color:#a6e22e>settlePromise</span>(<span style=color:#a6e22e>$rejected</span>, <span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81</span><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82</span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83</span><span>      <span style=color:#75715e>// å¤„ç†x
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84</span><span><span style=color:#75715e></span>      <span style=color:#a6e22e>next</span>.<span style=color:#a6e22e>settleWithX</span>(<span style=color:#a6e22e>x</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85</span><span>    });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87</span><span>  <span style=color:#a6e22e>settleWithX</span>(<span style=color:#a6e22e>x</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88</span><span>    <span style=color:#75715e>// ç¦æ­¢å¾ªç¯å¼•ç”¨ -&gt; resolveæˆ–rejectä¼ å…¥Promiseè‡ªèº«ï¼ˆè§„èŒƒ2.3.1.ï¼‰
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89</span><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>x</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90</span><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>settlePromise</span>(<span style=color:#a6e22e>$rejected</span>, <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TypeError</span>(<span style=color:#e6db74>&#34;promise_circular_chain&#34;</span>));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91</span><span>      <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93</span><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>xthen</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94</span><span>      <span style=color:#66d9ef>type</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>typeof</span> <span style=color:#a6e22e>x</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95</span><span>    <span style=color:#75715e>// è§„èŒƒ2.3.3.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96</span><span><span style=color:#75715e></span>    <span style=color:#75715e>// å¦‚æœxæ˜¯å‡½æ•°æˆ–å¯¹è±¡ï¼Œç”¨x.thenä½œä¸ºå½“å‰Promiseçš„then
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97</span><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>x</span> <span style=color:#f92672>!==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> (<span style=color:#66d9ef>type</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;function&#34;</span> <span style=color:#f92672>||</span> <span style=color:#66d9ef>type</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;object&#34;</span>)) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98</span><span>      <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99</span><span>        <span style=color:#a6e22e>xthen</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>x</span>.<span style=color:#a6e22e>then</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100</span><span>        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>typeof</span> <span style=color:#a6e22e>xthen</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;function&#34;</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101</span><span>          <span style=color:#75715e>// å¦‚æœx.thenæ˜¯å‡½æ•°çš„å¤„ç†
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102</span><span><span style=color:#75715e></span>          <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>settleXthen</span>(<span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>xthen</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103</span><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104</span><span>          <span style=color:#75715e>// å¦‚æœæ˜¯å¯¹è±¡ï¼Œç”¨xä½œä¸ºPromise resolveåçš„value
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105</span><span><span style=color:#75715e></span>          <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>settlePromise</span>(<span style=color:#a6e22e>$resolved</span>, <span style=color:#a6e22e>x</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107</span><span>      } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108</span><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>settlePromise</span>(<span style=color:#a6e22e>$rejected</span>, <span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109</span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110</span><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111</span><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>settlePromise</span>(<span style=color:#a6e22e>$resolved</span>, <span style=color:#a6e22e>x</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113</span><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115</span><span>  <span style=color:#a6e22e>settleXthen</span>(<span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>xthen</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116</span><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117</span><span>      <span style=color:#75715e>// è°ƒç”¨x.thenï¼Œä¸”this æŒ‡å‘xï¼ˆè§„èŒƒ2.3.3.3.ï¼‰
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118</span><span><span style=color:#75715e></span>      <span style=color:#75715e>// ä¼ å‚resolvePromiseã€rejectPromise
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119</span><span><span style=color:#75715e></span>      <span style=color:#a6e22e>xthen</span>.<span style=color:#a6e22e>call</span>(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120</span><span>        <span style=color:#a6e22e>x</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121</span><span>        <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>y</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122</span><span>          <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>x</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123</span><span>          <span style=color:#a6e22e>x</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124</span><span>          <span style=color:#75715e>// ç”¨ y resolve å½“å‰çš„promise
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125</span><span><span style=color:#75715e></span>          <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>settleWithX</span>(<span style=color:#a6e22e>y</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126</span><span>        },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127</span><span>        <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>r</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128</span><span>          <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>x</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129</span><span>          <span style=color:#a6e22e>x</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130</span><span>          <span style=color:#75715e>// ç”¨ r rejectå½“å‰çš„promise
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131</span><span><span style=color:#75715e></span>          <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>settlePromise</span>(<span style=color:#a6e22e>$rejected</span>, <span style=color:#a6e22e>r</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133</span><span>      );
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134</span><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135</span><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>x</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">136</span><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>settlePromise</span>(<span style=color:#a6e22e>$rejected</span>, <span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">137</span><span>        <span style=color:#a6e22e>x</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">138</span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">139</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">140</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">141</span><span>  <span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>onFulfilled</span>, <span style=color:#a6e22e>onRejected</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">142</span><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>addhandler</span>(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">143</span><span>      <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>MyPromise</span>(<span style=color:#66d9ef>function</span> () {}),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">144</span><span>      <span style=color:#a6e22e>onFulfilled</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">145</span><span>      <span style=color:#a6e22e>onRejected</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">146</span><span>    );
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">147</span><span>  } 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">148</span><span>}
</span></span></code></pre></div><p>ä»¥ä¸Šï¼Œå°±æ˜¯ä¸€ä¸ª<code>minimal Promise</code>çš„å®ç°ï¼Œæ”¯æŒæœ€åŸºæœ¬çš„<code>Promise</code>ç”¨æ³•ï¼Œæ”¯æŒ<code>then</code>çš„é“¾å¼è°ƒç”¨ï¼Œæ”¯æŒåŒä¸€ä¸ª<code>Promise</code>ä¸Šæ³¨å†Œå¤šæ¬¡<code>then</code>å›è°ƒï¼Œä¸å¦¨å…ˆè¯•è¯•ã€‚</p><p>&mldr;</p><p>&mldr;</p><p>ç­‰ä¸€ä¸‹ï¼Œä¸Šé¢çš„å®ç°è™½ç„¶èƒ½ç”¨ï¼Œä½†æ˜¯ä¸æ˜¯ç¼ºäº†ç‚¹å•¥ã€‚</p><p>æ²¡é”™ï¼ŒA+è§„èŒƒæœ¬èº«å¹¶æ²¡æœ‰å®šä¹‰<code>catch</code>å’Œ<code>finally</code>æ–¹æ³•ï¼Œä½†åœ¨å®é™…å¼€å‘ä¸­æ˜¯å¿…ä¸å¯å°‘çš„ã€‚</p><p>å¥½ï¼Œé‚£ä¹ˆè®©æˆ‘ä»¬æ¥åŠ¨æ‰‹åŠ ä¸Šè¿™ä¸¤ä¸ªæ–¹æ³•ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyPromise</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>  <span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>onRejected</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>then</span>(<span style=color:#66d9ef>undefined</span>, <span style=color:#a6e22e>onRejected</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>}
</span></span></code></pre></div><p><code>catch</code>å…¶å®å°±æ˜¯è°ƒç”¨<code>then</code>æ–¹æ³•æ—¶åªä¼ å…¥ç¬¬äºŒä¸ª<code>onRejected</code>å‚æ•°ï¼Œæœ¬è´¨ä¸Šæ˜¯è¯­æ³•ç³–ã€‚</p><p><code>finally</code>å®ç°ä¼šéº»çƒ¦ä¸€ç‚¹ï¼Œé¦–å…ˆæˆ‘ä»¬è¦æ”¯æŒ<code>Promise.resolve</code>å’Œ<code>Promise.reject</code>çš„ç”¨æ³•ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyPromise</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#66d9ef>static</span> <span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>value</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>value</span> <span style=color:#66d9ef>instanceof</span> <span style=color:#a6e22e>MyPromise</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>value</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>MyPromise</span>((<span style=color:#a6e22e>resolve</span>) =&gt; <span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>value</span>));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  <span style=color:#66d9ef>static</span> <span style=color:#a6e22e>reject</span>(<span style=color:#a6e22e>reason</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>MyPromise</span>((<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>reject</span>) =&gt; <span style=color:#a6e22e>reject</span>(<span style=color:#a6e22e>reason</span>));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>  <span style=color:#66d9ef>finally</span>(<span style=color:#a6e22e>onFinally</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>then</span>(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>      (<span style=color:#a6e22e>value</span>) =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>MyPromise</span>.<span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>onFinally</span>()).<span style=color:#a6e22e>then</span>(() =&gt; <span style=color:#a6e22e>value</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>      },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>      (<span style=color:#a6e22e>reason</span>) =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>MyPromise</span>.<span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>onFinally</span>()).<span style=color:#a6e22e>then</span>(() =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>          <span style=color:#66d9ef>throw</span> <span style=color:#a6e22e>reason</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    );
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>}
</span></span></code></pre></div><p>è‡³æ­¤ï¼Œä¸€ä¸ªåŠŸèƒ½åŸºæœ¬å®Œå¤‡çš„Promise API å°±ç®—å¤§åŠŸå‘Šæˆäº†ã€‚</p><p>ä¸‹ä¸€ç¯‡æˆ‘ä»¬ä¼šæ›´æ·±å…¥ä¸€äº›ï¼Œçœ‹çœ‹<code>Promise.race</code>ã€<code>Promise.all</code>ã€<code>Promise.allSettled</code> è¿™å‡ ä¸ªå¸¸ç”¨æ–¹æ³•çš„å®ç°åŸç†ã€‚</p><p>ï¼ˆEndï¼‰</p></div><footer class=post-footer></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://weita0.github.io/>Restart | é‡å¼€</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>