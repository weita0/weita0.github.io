<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>制造DOM | Restart | 重开</title><meta name=keywords content="React"><meta name=description content="React是如何产生DOM的？"><meta name=author content><link rel=canonical href=https://weita0.github.io/posts/react-1/><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://weita0.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://weita0.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://weita0.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://weita0.github.io/apple-touch-icon.png><link rel=mask-icon href=https://weita0.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://weita0.github.io/posts/react-1/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://weita0.github.io/posts/react-1/"><meta property="og:site_name" content="Restart | 重开"><meta property="og:title" content="制造DOM"><meta property="og:description" content="React是如何产生DOM的？"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-06-02T18:29:09+08:00"><meta property="article:modified_time" content="2025-06-02T18:29:09+08:00"><meta property="article:tag" content="React"><meta name=twitter:card content="summary"><meta name=twitter:title content="制造DOM"><meta name=twitter:description content="React是如何产生DOM的？"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://weita0.github.io/posts/"},{"@type":"ListItem","position":2,"name":"制造DOM","item":"https://weita0.github.io/posts/react-1/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"制造DOM","name":"制造DOM","description":"React是如何产生DOM的？","keywords":["React"],"articleBody":"引子 在我上学那会，还没有前端相关的课程（最接近前端的课程是用前端三剑客——Dreamweaver做HTML网页），学的编程语言是Java或C#。大四去公司实习，一开始也是写Java，后来一个机缘巧合，当时我的mentor让我选是继续做Java还是做前端，当时觉得前端所见即所得，很好玩，于是便开启了我的前端生涯。\n带我入门前端领域的第一本书是「JavaScript DOM编程艺术」，当时的前端还方兴未艾，React和Vue还不为大多数人所知，jQuery是当时的主流框架，日常开发就是使用$去查找DOM元素并直接在DOM上进行操作，没经历过那个时代很难想象。\n现如今，由于React及虚拟DOM的普及，实际开发中已经很少需要用到查找和直接操作DOM的方法了，这导致我们渐渐遗忘了这些API。本文（可能是一个系列）的初衷就是帮助自己和读者（假如有）搞懂React是如何替我们创建和维护DOM并把背后的复杂性给巧妙隐藏起来的。\n正文 React更新大致分为三个阶段：\nReconciliation 构建新的Fiber Tree，并标记每个节点的变化类型 Commit 根据标记更新实际的DOM，并执行副作用，包括DOM操作、ref、useEffect等 Passive Effects 异步执行useEffect中注册的副作用 在第一阶段，每个Fiber节点会被打上变化标记（存储在flags这个字段上）。 标记类型分为三种；Placement、Update、Deletion，对应新增、更新和删除。\n在第二阶段，React会从根节点开始，深度优先遍历Fiber Tree，检查每个节点的标记（flags），然后执行相应的操作。\n标记类型 操作 Placement insertDOMNode Update updateDOMNode Deletion removeChild 让我们来看一下新增节点的具体实现，这段源码在react/packages/react-reconciler/src/ReactFiberCommitHostEffects.js这个文件中，这里为了便于理解对源码做了一些精简。\n1function commitPlacement(finishedWork: Fiber): void { 2 let hostParentFiber; 3 let parentFiber = finishedWork.return; 4 while (parentFiber !== null) { 5 if (isHostParent(parentFiber)) { 6 hostParentFiber = parentFiber; 7 break; 8 } 9 parentFiber = parentFiber.return; 10 } 11 12 if (hostParentFiber == null) { 13 throw new Error( 14 'Expected to find a host parent. This error is likely caused by a bug ' + 15 'in React. Please file an issue.', 16 ); 17 } 18 19 switch (hostParentFiber.tag) { 20 case HostComponent: { 21 const parent: Instance = hostParentFiber.stateNode; 22 if (hostParentFiber.flags \u0026 ContentReset) { 23 // Reset the text content of the parent before doing any insertions 24 resetTextContent(parent); 25 // Clear ContentReset from the effect tag 26 hostParentFiber.flags \u0026= ~ContentReset; 27 } 28 29 const before = getHostSibling(finishedWork); 30 // We only have the top Fiber that was inserted but we need to recurse down its 31 // children to find all the terminal nodes. 32 insertOrAppendPlacementNode( 33 finishedWork, 34 before, 35 parent, 36 parentFragmentInstances, 37 ); 38 break; 39 } 40 case HostRoot: 41 case HostPortal: { 42 const parent: Container = hostParentFiber.stateNode.containerInfo; 43 const before = getHostSibling(finishedWork); 44 insertOrAppendPlacementNodeIntoContainer( 45 finishedWork, 46 before, 47 parent, 48 parentFragmentInstances, 49 ); 50 break; 51 } 52 default: 53 throw new Error( 54 'Invalid host parent fiber. This error is likely caused by a bug ' + 55 'in React. Please file an issue.', 56 ); 57 } 58} fiber.return指向当前fiber的父节点。\n向上回溯直到找到最近的宿主节点，如果没找到，直接抛出异常。\n调用getHostSibling方法查找当前fiber节点的兄弟节点的DOM实例。\n这里有两个关键方法：isHostParent和insertOrAppendPlacementNode，让我们分别看一下这两个方法。\n1function isHostParent(fiber: Fiber): boolean { 2 return ( 3 fiber.tag === HostComponent || 4 fiber.tag === HostRoot || 5 fiber.tag === HostPortal 6 ); 7} 该方法用于判断节点是否为合法的宿主节点。 可以看到，tag为HostComponent、HostRoot或HostPortal，就是合法的hostParent。\n1function insertOrAppendPlacementNode( 2 node: Fiber, 3 before: ?Instance, 4 parent: Instance, 5): void { 6 const {tag} = node; 7 const isHost = tag === HostComponent || tag === HostText; 8 if (isHost) { 9 const stateNode = node.stateNode; 10 if (before) { 11 insertBefore(parent, stateNode, before); 12 } else { 13 appendChild(parent, stateNode); 14 } 15 return; 16 } else if (tag === HostPortal) { 17 // If the insertion itself is a portal, then we don't want to traverse 18 // down its children. Instead, we'll get insertions from each child in 19 // the portal directly. 20 return; 21 } 22 23 const child = node.child; 24 if (child !== null) { 25 insertOrAppendPlacementNode(child, before, parent); 26 let sibling = child.sibling; 27 while (sibling !== null) { 28 insertOrAppendPlacementNode( 29 sibling, 30 before, 31 parent, 32 ); 33 sibling = sibling.sibling; 34 } 35 } 36} 在insertOrAppendPlacementNode中，如果有兄弟节点，则调用insertBefore将该节点插入这个兄弟节点前面。没有兄弟节点，再调用appendChild将该节点作为子节点插入父节点中。\n为什么要多此一举呢，为什么不统一用appendChild。\n…\n…\n…\n答案是为了在不破坏现有DOM的情况下，仅更新必要的部分，并保持DOM的顺序正确。\n举个例子\n1function App() { 2 const [list, setList] = useState(['A', 'C']); 3 4 return ( 5 \u003col\u003e 6 {list.map(item =\u003e \u003cli key={item}\u003e{item}\u003c/li\u003e)} 7 \u003c/ol\u003e 8 ) 9} 更新list\nsetList(['A', 'B', 'C']) 原先的DOM结构为\n\u003cli\u003eA\u003c/li\u003e \u003cli\u003eC\u003c/li\u003e 新的DOM结构应该为\n\u003cli\u003eA\u003c/li\u003e \u003cli\u003eB\u003c/li\u003e \u003cli\u003eC\u003c/li\u003e 如果只用appendChild，那么更新后的DOM结构就变为\n\u003cli\u003eA\u003c/li\u003e \u003cli\u003eC\u003c/li\u003e \u003cli\u003eB\u003c/li\u003e 显然是不正确❌的。因此要先找到兄弟节点，也就是 C，然后通过insertBefore插在这个节点之前。\n我们来看一下查找兄弟节点的具体过程\n1function getHostSibling(fiber: Fiber): ?Instance { 2 let node: Fiber = fiber; 3 siblings: while (true) { 4 // 找到兄弟节点，当前节点没有就去父节点里找，遍历顺序为 右-\u003e中-\u003e左 5 while (node.sibling === null) { 6 if (node.return === null || isHostParent(node.return)) { 7 return null; 8 } 9 node = node.return; 10 } 11 node.sibling.return = node.return; 12 node = node.sibling; 13 // 检查该节点是否是Host节点 14 while ( 15 node.tag !== HostComponent \u0026\u0026 16 node.tag !== HostText 17 ) { 18 // 跳过即将被插入的节点，因为它还没有在DOM上 19 if (node.flags \u0026 Placement) { 20 // If we don't have a child, try the siblings instead. 21 continue siblings; 22 } 23 if (node.child === null || node.tag === HostPortal) { 24 continue siblings; 25 } else { 26 node.child.return = node; 27 node = node.child; 28 } 29 } 30 // Check if this host node is stable or about to be placed. 31 if (!(node.flags \u0026 Placement)) { 32 // Found it! 33 return node.stateNode; 34 } 35 } 36} 这个实现用到了JS里的标记语句。\n请注意第19行和第33行的判断\n1if (node.flags \u0026 Placement) {} 2if (!(node.flags \u0026 Placement)) {} 这里用的位运算符\u0026而不是and——\u0026\u0026，要理解这种写法，需要知道Placement的具体定义，具体定义在react-reconciler/src/ReactFiberFlags.js这个文件中。\n1export type Flags = number; 2export const NoFlags = /* */ 0b0000000000000000000000000000000; 3export const Placement = /* */ 0b0000000000000000000000000000010; 4export const Update = /* */ 0b0000000000000000000000000000100; 5export const ChildDeletion = /**/ 0b0000000000000000000000000010000; 可以看到这些flag都是二进制数。\n再来看下fiber的定义，这个在react-reconciler/src/ReactInternalTypes.js中。\n1export type Fiber = { 2 tag: WorkTag, 3 key: null | string, 4 elementType: any, 5 type: any, 6 stateNode: any, 7 return: Fiber | null, 8 child: Fiber | null, 9 sibling: Fiber | null, 10 flags: Flags, 11 // ... 12} Flags虽然定义为number类型，但在实际使用中，flags也是一个二进制数，每一位1代表一种操作，比如0b0000000000000000000000000000110就表示Placement | Update。\n所以，node.flags \u0026 Placement为0意味着node.flags不包含Placement。 node.flags \u0026 Placement不为0意味着node.flags包含Placement。 非常巧妙的方式。\n回到最初的commitPlacement方法，我们看到对于HostComponent，调用的是insertOrApplendPlacementNode方法，而对于HostRoot和HostPortal，调用的是另一个insertOrAppendPlacementNodeIntoContainer方法，那么这个方法又有何不同。\nfunction insertOrAppendPlacementNodeIntoContainer( node: Fiber, before: ?Instance, parent: Container, ): void { const {tag} = node; const isHost = tag === HostComponent || tag === HostText; if (isHost) { const stateNode = node.stateNode; if (before) { insertInContainerBefore(parent, stateNode, before); } else { appendChildToContainer(parent, stateNode); } return; } else if (tag === HostPortal) { // If the insertion itself is a portal, then we don't want to traverse // down its children. Instead, we'll get insertions from each child in // the portal directly. return; } const child = node.child; if (child !== null) { insertOrAppendPlacementNodeIntoContainer( child, before, parent, ); let sibling = child.sibling; while (sibling !== null) { insertOrAppendPlacementNodeIntoContainer( sibling, before, parent, ); sibling = sibling.sibling; } } } 这个方法和insertOrAppendPlacement基本一致，区别在于实际执行插入时所调用的API：insertInContainerBefore和 appendChildToContainer。\n普通的DOM节点，用标准的DOM接口appendChild和insertBefore足矣。但对于容器来说，可能不是标准的DOM节点，在不同的平台（如React Native），需要通过shim的方式单独实现，以便于移植。（End）\n","wordCount":"883","inLanguage":"en","datePublished":"2025-06-02T18:29:09+08:00","dateModified":"2025-06-02T18:29:09+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://weita0.github.io/posts/react-1/"},"publisher":{"@type":"Organization","name":"Restart | 重开","logo":{"@type":"ImageObject","url":"https://weita0.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://weita0.github.io/ accesskey=h title="Restart | 重开 (Alt + H)">Restart | 重开</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">制造DOM</h1><div class=post-description>React是如何产生DOM的？</div><div class=post-meta><span title='2025-06-02 18:29:09 +0800 CST'>June 2, 2025</span></div><br><ul class=post-tags><li><a href=https://weita0.github.io/tags/react/>React</a></li></ul></header><div class=post-content><h2 id=引子>引子<a hidden class=anchor aria-hidden=true href=#引子>#</a></h2><p>在我上学那会，还没有前端相关的课程（最接近前端的课程是用前端三剑客——Dreamweaver做HTML网页），学的编程语言是Java或C#。大四去公司实习，一开始也是写Java，后来一个机缘巧合，当时我的mentor让我选是继续做Java还是做前端，当时觉得前端所见即所得，很好玩，于是便开启了我的前端生涯。</p><p>带我入门前端领域的第一本书是「JavaScript DOM编程艺术」，当时的前端还方兴未艾，React和Vue还不为大多数人所知，jQuery是当时的主流框架，日常开发就是使用<code>$</code>去查找DOM元素并直接在DOM上进行操作，没经历过那个时代很难想象。</p><p>现如今，由于React及虚拟DOM的普及，实际开发中已经很少需要用到查找和直接操作DOM的方法了，这导致我们渐渐遗忘了这些API。本文（可能是一个系列）的初衷就是帮助自己和读者（假如有）搞懂React是如何替我们创建和维护DOM并把背后的复杂性给巧妙隐藏起来的。</p><h2 id=正文>正文<a hidden class=anchor aria-hidden=true href=#正文>#</a></h2><p>React更新大致分为三个阶段：</p><ol><li>Reconciliation
构建新的Fiber Tree，并标记每个节点的变化类型</li><li>Commit
根据标记更新实际的DOM，并执行副作用，包括DOM操作、ref、useEffect等</li><li>Passive Effects
<strong>异步</strong>执行useEffect中注册的副作用</li></ol><p>在第一阶段，每个Fiber节点会被打上变化标记（存储在flags这个字段上）。
标记类型分为三种；Placement、Update、Deletion，对应新增、更新和删除。</p><p>在第二阶段，React会从根节点开始，深度优先遍历Fiber Tree，检查每个节点的标记（flags），然后执行相应的操作。</p><table><thead><tr><th>标记类型</th><th>操作</th></tr></thead><tbody><tr><td>Placement</td><td>insertDOMNode</td></tr><tr><td>Update</td><td>updateDOMNode</td></tr><tr><td>Deletion</td><td>removeChild</td></tr></tbody></table><p>让我们来看一下新增节点的具体实现，这段源码在<code>react/packages/react-reconciler/src/ReactFiberCommitHostEffects.js</code>这个文件中，这里为了便于理解对源码做了一些精简。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>commitPlacement</span>(<span style=color:#a6e22e>finishedWork</span>: <span style=color:#66d9ef>Fiber</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>hostParentFiber</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>parentFiber</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>finishedWork</span>.<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  <span style=color:#66d9ef>while</span> (<span style=color:#a6e22e>parentFiber</span> <span style=color:#f92672>!==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>isHostParent</span>(<span style=color:#a6e22e>parentFiber</span>)) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>      <span style=color:#a6e22e>hostParentFiber</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>parentFiber</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#a6e22e>parentFiber</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>parentFiber</span>.<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>hostParentFiber</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>      <span style=color:#e6db74>&#39;Expected to find a host parent. This error is likely caused by a bug &#39;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#e6db74>&#39;in React. Please file an issue.&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    );
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>  <span style=color:#66d9ef>switch</span> (<span style=color:#a6e22e>hostParentFiber</span>.<span style=color:#a6e22e>tag</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>HostComponent</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>parent</span>: <span style=color:#66d9ef>Instance</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>hostParentFiber</span>.<span style=color:#a6e22e>stateNode</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>hostParentFiber</span>.<span style=color:#a6e22e>flags</span> <span style=color:#f92672>&amp;</span> <span style=color:#a6e22e>ContentReset</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>        <span style=color:#75715e>// Reset the text content of the parent before doing any insertions
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#75715e></span>        <span style=color:#a6e22e>resetTextContent</span>(<span style=color:#a6e22e>parent</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>        <span style=color:#75715e>// Clear ContentReset from the effect tag
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#75715e></span>        <span style=color:#a6e22e>hostParentFiber</span>.<span style=color:#a6e22e>flags</span> <span style=color:#f92672>&amp;=</span> <span style=color:#f92672>~</span><span style=color:#a6e22e>ContentReset</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>before</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>getHostSibling</span>(<span style=color:#a6e22e>finishedWork</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>      <span style=color:#75715e>// We only have the top Fiber that was inserted but we need to recurse down its
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#75715e></span>      <span style=color:#75715e>// children to find all the terminal nodes.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#75715e></span>      <span style=color:#a6e22e>insertOrAppendPlacementNode</span>(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>        <span style=color:#a6e22e>finishedWork</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>        <span style=color:#a6e22e>before</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>        <span style=color:#a6e22e>parent</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>        <span style=color:#a6e22e>parentFragmentInstances</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>      );
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>HostRoot</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>HostPortal</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>parent</span>: <span style=color:#66d9ef>Container</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>hostParentFiber</span>.<span style=color:#a6e22e>stateNode</span>.<span style=color:#a6e22e>containerInfo</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>before</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>getHostSibling</span>(<span style=color:#a6e22e>finishedWork</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>      <span style=color:#a6e22e>insertOrAppendPlacementNodeIntoContainer</span>(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>        <span style=color:#a6e22e>finishedWork</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>        <span style=color:#a6e22e>before</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>        <span style=color:#a6e22e>parent</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>        <span style=color:#a6e22e>parentFragmentInstances</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>      );
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>    <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>        <span style=color:#e6db74>&#39;Invalid host parent fiber. This error is likely caused by a bug &#39;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>          <span style=color:#e6db74>&#39;in React. Please file an issue.&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>      );
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>}
</span></span></code></pre></div><p><code>fiber.return</code>指向当前fiber的父节点。</p><p>向上回溯直到找到最近的宿主节点，如果没找到，直接抛出异常。</p><p>调用<code>getHostSibling</code>方法查找当前fiber节点的兄弟节点的DOM实例。</p><p>这里有两个关键方法：<code>isHostParent</code>和<code>insertOrAppendPlacementNode</code>，让我们分别看一下这两个方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>isHostParent</span>(<span style=color:#a6e22e>fiber</span>: <span style=color:#66d9ef>Fiber</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>boolean</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>  <span style=color:#66d9ef>return</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    <span style=color:#a6e22e>fiber</span>.<span style=color:#a6e22e>tag</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>HostComponent</span> <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    <span style=color:#a6e22e>fiber</span>.<span style=color:#a6e22e>tag</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>HostRoot</span> <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    <span style=color:#a6e22e>fiber</span>.<span style=color:#a6e22e>tag</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>HostPortal</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>  );
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>}
</span></span></code></pre></div><p>该方法用于判断节点是否为合法的宿主节点。
可以看到，tag为<code>HostComponent</code>、<code>HostRoot</code>或<code>HostPortal</code>，就是合法的hostParent。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>insertOrAppendPlacementNode</span>(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#a6e22e>node</span>: <span style=color:#66d9ef>Fiber</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  <span style=color:#a6e22e>before</span>: <span style=color:#66d9ef>?Instance</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  <span style=color:#a6e22e>parent</span>: <span style=color:#66d9ef>Instance</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>  <span style=color:#66d9ef>const</span> {<span style=color:#a6e22e>tag</span>} <span style=color:#f92672>=</span> <span style=color:#a6e22e>node</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>isHost</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tag</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>HostComponent</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>tag</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>HostText</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>isHost</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>stateNode</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>stateNode</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>before</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>      <span style=color:#a6e22e>insertBefore</span>(<span style=color:#a6e22e>parent</span>, <span style=color:#a6e22e>stateNode</span>, <span style=color:#a6e22e>before</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>      <span style=color:#a6e22e>appendChild</span>(<span style=color:#a6e22e>parent</span>, <span style=color:#a6e22e>stateNode</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>  } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>tag</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>HostPortal</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#75715e>// If the insertion itself is a portal, then we don&#39;t want to traverse
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#75715e></span>    <span style=color:#75715e>// down its children. Instead, we&#39;ll get insertions from each child in
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#75715e></span>    <span style=color:#75715e>// the portal directly.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>child</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>child</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>child</span> <span style=color:#f92672>!==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    <span style=color:#a6e22e>insertOrAppendPlacementNode</span>(<span style=color:#a6e22e>child</span>, <span style=color:#a6e22e>before</span>, <span style=color:#a6e22e>parent</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>sibling</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>child</span>.<span style=color:#a6e22e>sibling</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    <span style=color:#66d9ef>while</span> (<span style=color:#a6e22e>sibling</span> <span style=color:#f92672>!==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>      <span style=color:#a6e22e>insertOrAppendPlacementNode</span>(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>        <span style=color:#a6e22e>sibling</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>        <span style=color:#a6e22e>before</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>        <span style=color:#a6e22e>parent</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>      );
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>      <span style=color:#a6e22e>sibling</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sibling</span>.<span style=color:#a6e22e>sibling</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>}
</span></span></code></pre></div><p>在<code>insertOrAppendPlacementNode</code>中，如果有兄弟节点，则调用<code>insertBefore</code>将该节点插入这个兄弟节点前面。没有兄弟节点，再调用<code>appendChild</code>将该节点作为子节点插入父节点中。</p><p>为什么要多此一举呢，为什么不统一用<code>appendChild</code>。</p><p>&mldr;</p><p>&mldr;</p><p>&mldr;</p><p>答案是为了在不破坏现有DOM的情况下，<strong>仅更新必要的部分，并保持DOM的顺序正确</strong>。</p><p>举个例子</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>App</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>  <span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>list</span>, <span style=color:#a6e22e>setList</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>useState</span>([<span style=color:#e6db74>&#39;A&#39;</span>, <span style=color:#e6db74>&#39;C&#39;</span>]);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>  <span style=color:#66d9ef>return</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    &lt;<span style=color:#f92672>ol</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>      {<span style=color:#a6e22e>list</span>.<span style=color:#a6e22e>map</span>(<span style=color:#a6e22e>item</span> =&gt; &lt;<span style=color:#f92672>li</span> <span style=color:#a6e22e>key</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>item</span>}&gt;{<span style=color:#a6e22e>item</span>}&lt;/<span style=color:#f92672>li</span>&gt;)}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    &lt;/<span style=color:#f92672>ol</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>  )
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span>}
</span></span></code></pre></div><p>更新list</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span><span style=color:#a6e22e>setList</span>([<span style=color:#e6db74>&#39;A&#39;</span>, <span style=color:#e6db74>&#39;B&#39;</span>, <span style=color:#e6db74>&#39;C&#39;</span>])
</span></span></code></pre></div><p>原先的DOM结构为</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>li</span>&gt;A&lt;/<span style=color:#f92672>li</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>li</span>&gt;C&lt;/<span style=color:#f92672>li</span>&gt;
</span></span></code></pre></div><p>新的DOM结构应该为</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>li</span>&gt;A&lt;/<span style=color:#f92672>li</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>li</span>&gt;B&lt;/<span style=color:#f92672>li</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>li</span>&gt;C&lt;/<span style=color:#f92672>li</span>&gt;
</span></span></code></pre></div><p>如果只用<code>appendChild</code>，那么更新后的DOM结构就变为</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>li</span>&gt;A&lt;/<span style=color:#f92672>li</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>li</span>&gt;C&lt;/<span style=color:#f92672>li</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>li</span>&gt;B&lt;/<span style=color:#f92672>li</span>&gt;
</span></span></code></pre></div><p>显然是不正确❌的。因此要先找到兄弟节点，也就是 <code>&lt;li>C&lt;/li></code>，然后通过<code>insertBefore</code>插在这个节点之前。</p><p>我们来看一下查找兄弟节点的具体过程</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getHostSibling</span>(<span style=color:#a6e22e>fiber</span>: <span style=color:#66d9ef>Fiber</span>)<span style=color:#f92672>:</span> <span style=color:#f92672>?</span><span style=color:#a6e22e>Instance</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>node</span>: <span style=color:#66d9ef>Fiber</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>fiber</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  <span style=color:#a6e22e>siblings</span>: <span style=color:#66d9ef>while</span> (<span style=color:#66d9ef>true</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#75715e>// 找到兄弟节点，当前节点没有就去父节点里找，遍历顺序为 右-&gt;中-&gt;左
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#75715e></span>    <span style=color:#66d9ef>while</span> (<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>sibling</span> <span style=color:#f92672>===</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>node</span>.<span style=color:#66d9ef>return</span> <span style=color:#f92672>===</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>isHostParent</span>(<span style=color:#a6e22e>node</span>.<span style=color:#66d9ef>return</span>)) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>      <span style=color:#a6e22e>node</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>node</span>.<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>sibling</span>.<span style=color:#66d9ef>return</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>node</span>.<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#a6e22e>node</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>sibling</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#75715e>// 检查该节点是否是Host节点
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#75715e></span>    <span style=color:#66d9ef>while</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>      <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>tag</span> <span style=color:#f92672>!==</span> <span style=color:#a6e22e>HostComponent</span> <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>      <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>tag</span> <span style=color:#f92672>!==</span> <span style=color:#a6e22e>HostText</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    ) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>      <span style=color:#75715e>// 跳过即将被插入的节点，因为它还没有在DOM上
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>flags</span> <span style=color:#f92672>&amp;</span> <span style=color:#a6e22e>Placement</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        <span style=color:#75715e>// If we don&#39;t have a child, try the siblings instead.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#75715e></span>        <span style=color:#66d9ef>continue</span> <span style=color:#a6e22e>siblings</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>child</span> <span style=color:#f92672>===</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>tag</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>HostPortal</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>        <span style=color:#66d9ef>continue</span> <span style=color:#a6e22e>siblings</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>        <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>child</span>.<span style=color:#66d9ef>return</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>node</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>        <span style=color:#a6e22e>node</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>child</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>    <span style=color:#75715e>// Check if this host node is stable or about to be placed.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>(<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>flags</span> <span style=color:#f92672>&amp;</span> <span style=color:#a6e22e>Placement</span>)) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>      <span style=color:#75715e>// Found it!
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#75715e></span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>stateNode</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>}
</span></span></code></pre></div><p>这个实现用到了JS里的<a href=https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/label>标记语句</a>。</p><p>请注意第19行和第33行的判断</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>flags</span> <span style=color:#f92672>&amp;</span> <span style=color:#a6e22e>Placement</span>) {}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>(<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>flags</span> <span style=color:#f92672>&amp;</span> <span style=color:#a6e22e>Placement</span>)) {}
</span></span></code></pre></div><p>这里用的位运算符<code>&</code>而不是<code>and</code>——<code>&&</code>，要理解这种写法，需要知道<code>Placement</code>的具体定义，具体定义在<code>react-reconciler/src/ReactFiberFlags.js</code>这个文件中。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Flags</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>NoFlags</span> <span style=color:#f92672>=</span> <span style=color:#75715e>/*      */</span> <span style=color:#ae81ff>0</span><span style=color:#a6e22e>b0000000000000000000000000000000</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Placement</span> <span style=color:#f92672>=</span> <span style=color:#75715e>/*    */</span> <span style=color:#ae81ff>0</span><span style=color:#a6e22e>b0000000000000000000000000000010</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Update</span> <span style=color:#f92672>=</span> <span style=color:#75715e>/*       */</span> <span style=color:#ae81ff>0</span><span style=color:#a6e22e>b0000000000000000000000000000100</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ChildDeletion</span> <span style=color:#f92672>=</span> <span style=color:#75715e>/**/</span> <span style=color:#ae81ff>0</span><span style=color:#a6e22e>b0000000000000000000000000010000</span>;
</span></span></code></pre></div><p>可以看到这些flag都是二进制数。</p><p>再来看下fiber的定义，这个在<code>react-reconciler/src/ReactInternalTypes.js</code>中。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Fiber</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#a6e22e>tag</span>: <span style=color:#66d9ef>WorkTag</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  <span style=color:#a6e22e>key</span>: <span style=color:#66d9ef>null</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  <span style=color:#a6e22e>elementType</span>: <span style=color:#66d9ef>any</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>any</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>  <span style=color:#a6e22e>stateNode</span>: <span style=color:#66d9ef>any</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  <span style=color:#66d9ef>return</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Fiber</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>  <span style=color:#a6e22e>child</span>: <span style=color:#66d9ef>Fiber</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  <span style=color:#a6e22e>sibling</span>: <span style=color:#66d9ef>Fiber</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  <span style=color:#a6e22e>flags</span>: <span style=color:#66d9ef>Flags</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>  <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>Flags虽然定义为number类型，但在实际使用中，flags也是一个二进制数，每一位<code>1</code>代表一种操作，比如<code>0b0000000000000000000000000000110</code>就表示<code>Placement | Update</code>。</p><p>所以，<code>node.flags & Placement</code>为0意味着<code>node.flags</code>不包含<code>Placement</code>。
<code>node.flags & Placement</code>不为0意味着<code>node.flags</code>包含<code>Placement</code>。
非常巧妙的方式。</p><p>回到最初的<code>commitPlacement</code>方法，我们看到对于<code>HostComponent</code>，调用的是<code>insertOrApplendPlacementNode</code>方法，而对于<code>HostRoot</code>和<code>HostPortal</code>，调用的是另一个<code>insertOrAppendPlacementNodeIntoContainer</code>方法，那么这个方法又有何不同。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>insertOrAppendPlacementNodeIntoContainer</span>(
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>node</span>: <span style=color:#66d9ef>Fiber</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>before</span>: <span style=color:#66d9ef>?Instance</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>parent</span>: <span style=color:#66d9ef>Container</span>,
</span></span><span style=display:flex><span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> {<span style=color:#a6e22e>tag</span>} <span style=color:#f92672>=</span> <span style=color:#a6e22e>node</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>isHost</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tag</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>HostComponent</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>tag</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>HostText</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>isHost</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>stateNode</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>stateNode</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>before</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>insertInContainerBefore</span>(<span style=color:#a6e22e>parent</span>, <span style=color:#a6e22e>stateNode</span>, <span style=color:#a6e22e>before</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>appendChildToContainer</span>(<span style=color:#a6e22e>parent</span>, <span style=color:#a6e22e>stateNode</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>tag</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>HostPortal</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// If the insertion itself is a portal, then we don&#39;t want to traverse
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// down its children. Instead, we&#39;ll get insertions from each child in
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// the portal directly.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>child</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>child</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>child</span> <span style=color:#f92672>!==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>insertOrAppendPlacementNodeIntoContainer</span>(
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>child</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>before</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>parent</span>,
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>sibling</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>child</span>.<span style=color:#a6e22e>sibling</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#a6e22e>sibling</span> <span style=color:#f92672>!==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>insertOrAppendPlacementNodeIntoContainer</span>(
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sibling</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>before</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>parent</span>,
</span></span><span style=display:flex><span>      );
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>sibling</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sibling</span>.<span style=color:#a6e22e>sibling</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这个方法和<code>insertOrAppendPlacement</code>基本一致，区别在于实际执行插入时所调用的API：<code>insertInContainerBefore</code>和 <code>appendChildToContainer</code>。</p><p>普通的DOM节点，用标准的DOM接口<code>appendChild</code>和<code>insertBefore</code>足矣。但对于容器来说，可能不是标准的DOM节点，在不同的平台（如React Native），需要通过<code>shim</code>的方式单独实现，以便于移植。（End）</p></div><footer class=post-footer></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://weita0.github.io/>Restart | 重开</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>