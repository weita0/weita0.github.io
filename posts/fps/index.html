<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>FPS | Restart | 重开</title><meta name=keywords content="JavaScript,React"><meta name=description content="用JavaScript获取页面实时FPS及其背后的实现原理"><meta name=author content><link rel=canonical href=https://weita0.github.io/posts/fps/><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://weita0.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://weita0.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://weita0.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://weita0.github.io/apple-touch-icon.png><link rel=mask-icon href=https://weita0.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://weita0.github.io/posts/fps/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://weita0.github.io/posts/fps/"><meta property="og:site_name" content="Restart | 重开"><meta property="og:title" content="FPS"><meta property="og:description" content="用JavaScript获取页面实时FPS及其背后的实现原理"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-05-26T23:15:58+08:00"><meta property="article:modified_time" content="2025-05-26T23:15:58+08:00"><meta property="article:tag" content="JavaScript"><meta property="article:tag" content="React"><meta name=twitter:card content="summary"><meta name=twitter:title content="FPS"><meta name=twitter:description content="用JavaScript获取页面实时FPS及其背后的实现原理"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://weita0.github.io/posts/"},{"@type":"ListItem","position":2,"name":"FPS","item":"https://weita0.github.io/posts/fps/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"FPS","name":"FPS","description":"用JavaScript获取页面实时FPS及其背后的实现原理","keywords":["JavaScript","React"],"articleBody":"如何通过JavaScript获知当前页面的实时帧数，虽然没有类似getFPS这样的方法可以直接调用，但我们可以自己实现一个。\n1import { useEffect, useState } from \"react\"; 2 3function FPSIndex() { 4 const [fps, setFps] = useState(0); 5 6 useEffect(() =\u003e { 7 let lastTime = performance.now(); 8 let frame = 0; 9 let fps = 0; 10 11 function loop(now) { 12 frame++; 13 14 const delta = now - lastTime; 15 if (delta \u003e= 1000) { 16 fps = frame / (delta / 1000); 17 setFps(fps); 18 frame = 0; 19 lastTime = now; 20 } 21 22 requestAnimationFrame(loop); 23 } 24 25 requestAnimationFrame(loop); 26 }, []); 27 28 return \u003ch1\u003e{`FPS: ${fps.toFixed(0)}`}\u003c/h1\u003e; 29} 在我的mbp上，显示帧数在120帧左右，将页面移到扩展屏上，数值变为60左右，还是比较准确的。\n上面的方法里，用到了一个关键的API —— requestAnimationFrame，它是浏览器提供的方法，会在浏览器下一次重绘之前，调用传入的回调函数。我们记录在1s内函数被调用的次数，从而推算出FPS。\ncallback函数只有一个参数 —— 上一帧渲染的结束时间戳，单位是毫秒。\n众所周知，React底层用requestAnimationFrame来执行高优先级任务，用requestIdleCallback执行低优先级任务。这一点后面值得单独开一篇来研究，这里暂且按下不表。\n那么，还有哪些场景下，需要用到requestAnimationFrame这个API呢。\n1. 平滑动画：精确控制动画的更新时机 1const App = () =\u003e { 2 const ref = useRef\u003cHTMLDivElement\u003e(null); 3 useEffect(() =\u003e { 4 let now = performance.now(); 5 let progress = 0; 6 function loop(ts: number) { 7 if (!ref.current) return; 8 9 if (ts - now \u003e= 500) { 10 ref.current.style.right = `${100 - ++progress}%`; 11 now = ts; 12 } 13 14 if (progress \u003c 100) { 15 requestAnimationFrame(loop); 16 } 17 } 18 19 requestAnimationFrame(loop); 20 }, []); 21 return ( 22 \u003cdiv\u003e 23 \u003ch1\u003e进度条\u003c/h1\u003e 24 \u003cdiv className=\"w-100 h-10 border border-[#ccc] relative\"\u003e 25 \u003cdiv className=\"absolute top-0 bottom-0 left-0 bg-[#ccc]\" ref={ref} /\u003e 26 \u003c/div\u003e 27 \u003c/div\u003e 28 ); 29}; 这是一个进度条，每过0.5s进度条会增加1%，直到达到100%。\n可能有人会说，用setInterval不也一样可以实现吗。确实可以，但requestAnimationFrame拥有setInterval无法比拟的优势：\n✅ 比setTimeout/setInterval更平滑 ✅ 可以避免动画卡顿、跳帧 ✅ 跟随浏览器的绘制节奏，不做无用功 2. 滚动、拖拽的交互动画 如果在mousemove事件里直接更改DOM元素的位置，会比较消耗性能，可以放在requestAnimationFrame里，在每一帧集中处理，减少操作DOM的频率。\n1const App = () =\u003e { 2 const position = useRef([0, 0]); 3 const ref = useRef\u003cHTMLDivElement\u003e(null); 4 5 useEffect(() =\u003e { 6 function updatePosition(e: MouseEvent) { 7 position.current = [e.clientX, e.clientY]; 8 } 9 window.addEventListener(\"mousemove\", updatePosition); 10 11 function render() { 12 if (!ref.current) return; 13 14 ref.current.style.left = `${position.current[0]}px`; 15 ref.current.style.top = `${position.current[1]}px`; 16 requestAnimationFrame(render); 17 } 18 19 render(); 20 21 return () =\u003e { 22 window.removeEventListener(\"mousemove\", updatePosition); 23 }; 24 }, []); 25 26 return \u003cdiv ref={ref} className=\"h-10 w-10 rounded-full bg-amber-500 absolute\"\u003e\u003c/div\u003e; 27}; 这里展示了一个跟随鼠标移动的div。在mousemove里只记录鼠标最新的位置，对DOM的操作放在requstAnimationFrame里进行。实际效果非常流畅。\n写到这里，想起几年前，在做一个项目需求的时候，把操作都放在了mousemove事件里执行，导致页面卡顿。为了优化，给mousemove事件加了一个节流 —— throttle。现在，我们显然有了更好的方案。（End）\n","wordCount":"313","inLanguage":"en","datePublished":"2025-05-26T23:15:58+08:00","dateModified":"2025-05-26T23:15:58+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://weita0.github.io/posts/fps/"},"publisher":{"@type":"Organization","name":"Restart | 重开","logo":{"@type":"ImageObject","url":"https://weita0.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://weita0.github.io/ accesskey=h title="Restart | 重开 (Alt + H)">Restart | 重开</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">FPS</h1><div class=post-description>用JavaScript获取页面实时FPS及其背后的实现原理</div><div class=post-meta><span title='2025-05-26 23:15:58 +0800 CST'>May 26, 2025</span></div><br><ul class=post-tags><li><a href=https://weita0.github.io/tags/javascript/>JavaScript</a></li><li><a href=https://weita0.github.io/tags/react/>React</a></li></ul></header><div class=post-content><p>如何通过JavaScript获知当前页面的实时帧数，虽然没有类似<code>getFPS</code>这样的方法可以直接调用，但我们可以自己实现一个。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>useEffect</span>, <span style=color:#a6e22e>useState</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;react&#34;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>FPSIndex</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  <span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>fps</span>, <span style=color:#a6e22e>setFps</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>useState</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>  <span style=color:#a6e22e>useEffect</span>(() =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>lastTime</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>performance</span>.<span style=color:#a6e22e>now</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>frame</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>fps</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>loop</span>(<span style=color:#a6e22e>now</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>      <span style=color:#a6e22e>frame</span><span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>delta</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>now</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>lastTime</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>delta</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>1000</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        <span style=color:#a6e22e>fps</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>frame</span> <span style=color:#f92672>/</span> (<span style=color:#a6e22e>delta</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>1000</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        <span style=color:#a6e22e>setFps</span>(<span style=color:#a6e22e>fps</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        <span style=color:#a6e22e>frame</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#a6e22e>lastTime</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>now</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>      <span style=color:#a6e22e>requestAnimationFrame</span>(<span style=color:#a6e22e>loop</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    <span style=color:#a6e22e>requestAnimationFrame</span>(<span style=color:#a6e22e>loop</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>  }, []);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>  <span style=color:#66d9ef>return</span> &lt;<span style=color:#f92672>h1</span>&gt;{<span style=color:#e6db74>`FPS: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>fps</span>.<span style=color:#a6e22e>toFixed</span>(<span style=color:#ae81ff>0</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>}&lt;/<span style=color:#f92672>h1</span>&gt;;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>}
</span></span></code></pre></div><p><img loading=lazy src=/posts/fps/images/demo.gif></p><p>在我的mbp上，显示帧数在120帧左右，将页面移到扩展屏上，数值变为60左右，还是比较准确的。</p><p>上面的方法里，用到了一个关键的API —— <code>requestAnimationFrame</code>，它是浏览器提供的方法，会在浏览器下一次重绘之前，调用传入的回调函数。我们记录在1s内函数被调用的次数，从而推算出FPS。</p><p>callback函数只有一个参数 —— 上一帧渲染的结束时间戳，单位是毫秒。</p><p>众所周知，React底层用<code>requestAnimationFrame</code>来执行高优先级任务，用<code>requestIdleCallback</code>执行低优先级任务。这一点后面值得单独开一篇来研究，这里暂且按下不表。</p><p>那么，还有哪些场景下，需要用到<code>requestAnimationFrame</code>这个API呢。</p><h2 id=1-平滑动画精确控制动画的更新时机>1. 平滑动画：精确控制动画的更新时机<a hidden class=anchor aria-hidden=true href=#1-平滑动画精确控制动画的更新时机>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>App</span> <span style=color:#f92672>=</span> () =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ref</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>useRef</span>&lt;<span style=color:#f92672>HTMLDivElement</span>&gt;(<span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  <span style=color:#a6e22e>useEffect</span>(() =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>now</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>performance</span>.<span style=color:#a6e22e>now</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>progress</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>loop</span>(<span style=color:#a6e22e>ts</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>number</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>ref</span>.<span style=color:#a6e22e>current</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>ts</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>now</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>500</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        <span style=color:#a6e22e>ref</span>.<span style=color:#a6e22e>current</span>.<span style=color:#a6e22e>style</span>.<span style=color:#a6e22e>right</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#ae81ff>100</span> <span style=color:#f92672>-</span> <span style=color:#f92672>++</span><span style=color:#a6e22e>progress</span><span style=color:#e6db74>}</span><span style=color:#e6db74>%`</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#a6e22e>now</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ts</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>progress</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>100</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#a6e22e>requestAnimationFrame</span>(<span style=color:#a6e22e>loop</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#a6e22e>requestAnimationFrame</span>(<span style=color:#a6e22e>loop</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>  }, []);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>  <span style=color:#66d9ef>return</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    &lt;<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>      &lt;<span style=color:#f92672>h1</span>&gt;<span style=color:#a6e22e>进度条</span>&lt;/<span style=color:#f92672>h1</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>      &lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>className</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;w-100 h-10 border border-[#ccc] relative&#34;</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>        &lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>className</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;absolute top-0 bottom-0 left-0 bg-[#ccc]&#34;</span> <span style=color:#a6e22e>ref</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>ref</span>} /&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>      &lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    &lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>  );
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>};
</span></span></code></pre></div><p>这是一个进度条，每过0.5s进度条会增加1%，直到达到100%。</p><p><img loading=lazy src=/posts/fps/images/demo-1.gif></p><p>可能有人会说，用<code>setInterval</code>不也一样可以实现吗。确实可以，但<code>requestAnimationFrame</code>拥有<code>setInterval</code>无法比拟的优势：</p><ul><li>✅ 比<code>setTimeout</code>/<code>setInterval</code>更平滑</li><li>✅ 可以避免动画卡顿、跳帧</li><li>✅ 跟随浏览器的绘制节奏，不做无用功</li></ul><h2 id=2-滚动拖拽的交互动画>2. 滚动、拖拽的交互动画<a hidden class=anchor aria-hidden=true href=#2-滚动拖拽的交互动画>#</a></h2><p>如果在<code>mousemove</code>事件里直接更改DOM元素的位置，会比较消耗性能，可以放在<code>requestAnimationFrame</code>里，在每一帧集中处理，减少操作DOM的频率。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>App</span> <span style=color:#f92672>=</span> () =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>position</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>useRef</span>([<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>]);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ref</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>useRef</span>&lt;<span style=color:#f92672>HTMLDivElement</span>&gt;(<span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  <span style=color:#a6e22e>useEffect</span>(() =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>updatePosition</span>(<span style=color:#a6e22e>e</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>MouseEvent</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>      <span style=color:#a6e22e>position</span>.<span style=color:#a6e22e>current</span> <span style=color:#f92672>=</span> [<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>clientX</span>, <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>clientY</span>];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    window.<span style=color:#a6e22e>addEventListener</span>(<span style=color:#e6db74>&#34;mousemove&#34;</span>, <span style=color:#a6e22e>updatePosition</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>render</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>ref</span>.<span style=color:#a6e22e>current</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>      <span style=color:#a6e22e>ref</span>.<span style=color:#a6e22e>current</span>.<span style=color:#a6e22e>style</span>.<span style=color:#a6e22e>left</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>position</span>.<span style=color:#a6e22e>current</span>[<span style=color:#ae81ff>0</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>px`</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>      <span style=color:#a6e22e>ref</span>.<span style=color:#a6e22e>current</span>.<span style=color:#a6e22e>style</span>.<span style=color:#a6e22e>top</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>position</span>.<span style=color:#a6e22e>current</span>[<span style=color:#ae81ff>1</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>px`</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>      <span style=color:#a6e22e>requestAnimationFrame</span>(<span style=color:#a6e22e>render</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#a6e22e>render</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    <span style=color:#66d9ef>return</span> () =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>      window.<span style=color:#a6e22e>removeEventListener</span>(<span style=color:#e6db74>&#34;mousemove&#34;</span>, <span style=color:#a6e22e>updatePosition</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    };
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>  }, []);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>  <span style=color:#66d9ef>return</span> &lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>ref</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>ref</span>} <span style=color:#a6e22e>className</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;h-10 w-10 rounded-full bg-amber-500 absolute&#34;</span>&gt;&lt;/<span style=color:#f92672>div</span>&gt;;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>};
</span></span></code></pre></div><p>这里展示了一个跟随鼠标移动的<code>div</code>。在<code>mousemove</code>里只记录鼠标最新的位置，对DOM的操作放在<code>requstAnimationFrame</code>里进行。实际效果非常流畅。</p><p><img loading=lazy src=/posts/fps/images/demo-2.gif></p><p>写到这里，想起几年前，在做一个项目需求的时候，把操作都放在了<code>mousemove</code>事件里执行，导致页面卡顿。为了优化，给<code>mousemove</code>事件加了一个节流 —— <code>throttle</code>。现在，我们显然有了更好的方案。（End）</p></div><footer class=post-footer></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://weita0.github.io/>Restart | 重开</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>